<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TBD</title>
<script src="https://cdn.plot.ly/plotly-2.35.0.min.js"></script>
<style>
/* ============================================================
   TBD — Theme
   ============================================================ */
:root {
  --so-orange: #F48024;
  --so-dark: #232629;
  --so-bg: #F1F2F3;
  --so-white: #ffffff;
  --so-border: #d6d9dc;
  --so-text: #3b4045;
  --so-text-light: #6a737c;
  --so-link: #0074CC;
  --so-tag-bg: #E1ECF4;
  --so-tag-text: #39739D;
  --so-green: #2F6F44;
  --so-green-bg: #d4edda;
  --so-red: #C22E32;
  --so-yellow-bg: #FDF7E2;
  --tier1: #2F6F44;
  --tier2: #5B6987;
  --check-good: #48A868;
  --check-warn: #E8A317;
  --check-bad: #D1383D;
  --check-skip: #BFC0C3;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Liberation Sans", sans-serif;
  font-size: 13px;
  color: var(--so-text);
  background: var(--so-bg);
  line-height: 1.5;
}

/* ---- Header ---- */
.header {
  background: var(--so-dark);
  height: 50px;
  display: flex;
  align-items: center;
  padding: 0 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 1px 2px rgba(0,0,0,.1);
}
.header-logo {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--so-white);
  font-size: 18px;
  font-weight: 400;
  text-decoration: none;
  padding: 0 8px;
  cursor: pointer;
}
.header-logo .logo-stack { font-weight: 300; }
.header-logo .logo-over { font-weight: 700; color: var(--so-orange); }
.header-logo .logo-bond { font-weight: 300; }

.header-nav {
  display: flex;
  gap: 4px;
  margin-left: 16px;
}
.header-nav a {
  color: #b6bdc4;
  text-decoration: none;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  cursor: pointer;
  transition: background .15s, color .15s;
}
.header-nav a:hover { background: #3b4045; color: #fff; }
.header-nav a.active { background: var(--so-orange); color: #fff; }

.header-search {
  flex: 1;
  max-width: 500px;
  margin-left: 16px;
  position: relative;
}
.header-search input {
  width: 100%;
  padding: 6px 30px 6px 10px;
  border: 1px solid #555;
  border-radius: 3px;
  background: #3b4045;
  color: #fff;
  font-size: 13px;
  outline: none;
}
.header-search input:focus { border-color: var(--so-link); background: #232629; }
.header-search input::placeholder { color: #848d95; }

/* ---- Main layout ---- */
.main-container {
  max-width: 1264px;
  margin: 0 auto;
  display: flex;
  gap: 24px;
  padding: 24px 16px;
}
.content-area { flex: 1; min-width: 0; }
.sidebar { width: 300px; flex-shrink: 0; }

/* ---- Material list ---- */
.material-list-item {
  background: var(--so-white);
  border: 1px solid var(--so-border);
  border-bottom: none;
  padding: 12px 16px;
  display: flex;
  gap: 16px;
  align-items: flex-start;
  cursor: pointer;
  transition: background .1s;
}
.material-list-item:last-child { border-bottom: 1px solid var(--so-border); }
.material-list-item:hover { background: #f8f9f9; }
.material-list-item.expanded { background: var(--so-yellow-bg); border-left: 3px solid var(--so-orange); position: sticky; top: 50px; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
.material-list-item.expanded .mat-question { display: none; }
.material-list-item.expanded .mat-question.restore { display: block; }

.mat-confidence {
  width: 108px;
  flex-shrink: 0;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.confidence-bar {
  width: 100%;
  height: 16px;
  border-radius: 4px;
  display: flex;
  overflow: hidden;
  background: var(--check-skip);
  gap: 1px;
}
.confidence-bar .seg {
  height: 100%;
  position: relative;
  cursor: help;
}
.confidence-bar .seg:hover { opacity: 0.8; }
.bar-tooltip {
  position: fixed;
  background: var(--so-dark);
  color: #fff;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
  z-index: 1000;
  pointer-events: none;
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
  display: none;
}
.confidence-bar .seg.good { background: var(--check-good); }
.confidence-bar .seg.warn { background: var(--check-warn); }
.confidence-bar .seg.bad { background: var(--check-bad); }
.confidence-bar .seg.skip { background: var(--check-skip); }

.confidence-score {
  font-size: 18px;
  font-weight: 600;
  color: var(--so-text);
}
.confidence-score.good { color: var(--check-good); }
.confidence-score.warn { color: var(--check-warn); }
.confidence-score.bad { color: var(--check-bad); }

/* Material info column */
.mat-info { flex: 1; min-width: 0; }
.mat-title {
  font-size: 17px;
  color: var(--so-link);
  margin-bottom: 4px;
  font-weight: 400;
}
.mat-title:hover { color: #0a95ff; }
.mat-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}
.mat-question {
  font-size: 12px;
  color: var(--so-text-light);
  margin-top: 6px;
  font-style: italic;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.tag {
  display: inline-block;
  padding: 2px 6px;
  background: var(--so-tag-bg);
  color: var(--so-tag-text);
  border-radius: 3px;
  font-size: 12px;
  white-space: nowrap;
}
.match-pill {
  display: inline-block;
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  vertical-align: middle;
  margin-left: 4px;
  letter-spacing: 0.3px;
}
.match-pill.novel { background: #155724; color: #fff; }
.match-pill.comp-known { background: #856404; color: #fff; }
.match-pill.exp-known { background: #0c5460; color: #fff; }

.tag.novel { background: #d4edda; color: #155724; }
.tag.comp-known { background: #fff3cd; color: #856404; }
.tag.exp-known { background: #d1ecf1; color: #0c5460; }
.tag.oxi-low { background: #fce4e4; color: var(--so-red); }
.tag.mixed-valence { background: #f3e5f5; color: #7b1fa2; }

/* ---- Detail panel (expands inline) ---- */
.detail-panel {
  background: var(--so-white);
  border: 1px solid var(--so-border);
  border-top: none;
  padding: 16px 24px;
  display: none;
}
.detail-panel.open { display: block; }

.detail-section {
  margin-bottom: 20px;
}
.detail-section h3 {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--so-text);
  border-bottom: 1px solid var(--so-border);
  padding-bottom: 4px;
}

/* ---- Validation check cards ---- */
.check-answer {
  border: 1px solid var(--so-border);
  border-radius: 4px;
  margin-bottom: 8px;
  overflow: hidden;
}
.check-answer-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: #f8f9f9;
  border-bottom: 1px solid var(--so-border);
}
.check-answer-header .check-icon {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
  color: #fff;
  flex-shrink: 0;
}
.check-answer-header .check-icon.good { background: var(--check-good); }
.check-answer-header .check-icon.warn { background: var(--check-warn); }
.check-answer-header .check-icon.bad { background: var(--check-bad); }
.check-answer-header .check-icon.skip { background: var(--check-skip); }

.check-answer-header .check-name {
  font-weight: 600;
  font-size: 13px;
}
.check-answer-header .check-tier {
  margin-left: auto;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
}
.check-answer-header .check-tier.tier1 {
  background: #e8f5e9;
  color: var(--tier1);
}
.check-answer-header .check-tier.tier2 {
  background: #e3e8ef;
  color: var(--tier2);
}

.check-answer-body {
  padding: 8px 12px;
}
.check-answer-body .score-line {
  font-size: 13px;
  margin-bottom: 4px;
}
.check-name-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
}
.assumption-tip {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--so-border);
  color: var(--so-text-light);
  font-size: 11px;
  font-weight: 700;
  cursor: help;
  flex-shrink: 0;
}
.assumption-tip .tip-text {
  display: none;
  position: fixed;
  background: var(--so-dark);
  color: #fff;
  padding: 8px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 400;
  line-height: 1.4;
  width: 320px;
  z-index: 1000;
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
  pointer-events: none;
}
.check-answer-body .detail-row {
  font-size: 12px;
  color: var(--so-text-light);
  margin: 2px 0;
}

/* ---- Sidebar widgets ---- */
.sidebar-widget {
  background: var(--so-white);
  border: 1px solid var(--so-border);
  border-radius: 4px;
  margin-bottom: 16px;
  overflow: hidden;
}
.sidebar-widget-header {
  background: #f8f9f9;
  padding: 10px 14px;
  border-bottom: 1px solid var(--so-border);
  font-weight: 600;
  font-size: 13px;
  color: var(--so-text);
}
.sidebar-widget-body {
  padding: 12px 14px;
}

/* ---- Interesting failures ---- */
.hot-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  padding: 6px 0;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  font-size: 12px;
  color: var(--so-link);
  text-decoration: none;
}
.hot-item:last-child { border-bottom: none; }
.hot-item:hover { color: #0a95ff; }
.hot-item .hot-icon {
  font-size: 14px;
  flex-shrink: 0;
  margin-top: 1px;
}
.hot-item .hot-label {
  font-size: 10px;
  color: var(--so-text-light);
  margin-top: 2px;
}

/* Stats widget */
.stat-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 12px;
}
.stat-row .stat-val {
  font-weight: 700;
}

/* ---- Filters bar ---- */
.filters-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
  align-items: center;
}
.filters-bar select {
  padding: 4px 32px 4px 8px;
  border: 1px solid var(--so-border);
  border-radius: 3px;
  font-size: 12px;
  background: var(--so-white);
  color: var(--so-text);
}
.filters-bar .filter-label {
  font-size: 12px;
  color: var(--so-text-light);
  font-weight: 600;
}
.sort-tabs {
  display: flex;
  align-items: center;
  gap: 0;
  margin-left: auto;
}
.sort-tabs button {
  padding: 4px 12px;
  border: 1px solid var(--so-border);
  background: var(--so-white);
  font-size: 12px;
  color: var(--so-text-light);
  cursor: pointer;
}
.sort-tabs button:first-of-type { border-radius: 3px 0 0 3px; }
.sort-tabs button:last-of-type { border-radius: 0 3px 3px 0; }
.sort-tabs button:not(:first-of-type) { border-left: none; }
.sort-tabs button.active { background: #e3e6e8; color: var(--so-text); }

/* ---- Dashboard ---- */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 24px;
}
.dashboard-card {
  background: var(--so-white);
  border: 1px solid var(--so-border);
  border-radius: 4px;
  padding: 16px;
}
.dashboard-card.full-width {
  grid-column: 1 / -1;
}
.dashboard-card h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--so-text);
}

.big-stat {
  text-align: center;
  padding: 12px;
}
.big-stat .num {
  font-size: 36px;
  font-weight: 700;
  color: var(--so-orange);
}
.big-stat .label {
  font-size: 13px;
  color: var(--so-text-light);
}

/* ---- Hero / Featured Failure ---- */
.hero-banner {
  background: linear-gradient(135deg, var(--so-dark) 0%, #3b4045 100%);
  border-radius: 8px;
  padding: 28px 32px;
  margin-bottom: 24px;
  color: #fff;
  position: relative;
  overflow: hidden;
}
.hero-banner::after {
  content: "";
  position: absolute;
  right: -40px;
  top: -40px;
  width: 200px;
  height: 200px;
  border-radius: 50%;
  background: rgba(244, 128, 36, 0.08);
}
.hero-banner h2 {
  font-size: 22px;
  font-weight: 400;
  margin-bottom: 4px;
}
.hero-banner .hero-sub {
  font-size: 14px;
  color: #b6bdc4;
  margin-bottom: 8px;
}

/* ---- Pagination ---- */
.pagination {
  display: flex;
  justify-content: center;
  gap: 4px;
  margin-top: 16px;
}
.pagination button {
  padding: 4px 10px;
  border: 1px solid var(--so-border);
  background: var(--so-white);
  border-radius: 3px;
  font-size: 12px;
  cursor: pointer;
  color: var(--so-text);
}
.pagination button.active {
  background: var(--so-orange);
  color: #fff;
  border-color: var(--so-orange);
}
.pagination button:hover:not(.active) { background: #e3e6e8; }

/* ---- Responsive ---- */
@media (max-width: 980px) {
  .sidebar { display: none; }
  .dashboard-grid { grid-template-columns: 1fr; }
}

/* ---- Utilities ---- */
.hidden { display: none !important; }
.text-muted { color: var(--so-text-light); }
.text-good { color: var(--check-good); }
.text-warn { color: var(--check-warn); }
.text-bad { color: var(--check-bad); }
.mt-8 { margin-top: 8px; }
sub { font-size: 0.75em; }

/* ---- Claude question ---- */
.claude-question {
  background: #FFF8F0;
  border: 1px solid #f0dcc0;
  border-radius: 6px;
  padding: 12px 16px;
  margin-bottom: 16px;
  font-size: 14px;
  color: var(--so-text);
  line-height: 1.5;
}
.claude-question-label {
  font-weight: 600;
  color: var(--so-orange);
}

/* ---- Claude dashboard widget ---- */
.opus-dashboard-widget {
  background: #FFF8F0;
  border: 1px solid #f0dcc0;
  border-radius: 4px;
  padding: 16px;
  margin-bottom: 16px;
}
.opus-dashboard-widget h3 {
  font-size: 14px;
  font-weight: 600;
  color: var(--so-orange);
  margin-bottom: 12px;
}
.opus-dashboard-item {
  padding: 8px 0;
  border-bottom: 1px solid #f0dcc0;
  cursor: pointer;
}
.opus-dashboard-item:last-child { border-bottom: none; padding-bottom: 0; }
.opus-dashboard-item:hover { background: #FFF0E0; margin: 0 -16px; padding: 8px 16px; }
.opus-dashboard-item .opus-d-formula {
  font-size: 13px;
  font-weight: 600;
  color: var(--so-link);
}
.opus-dashboard-item .opus-d-question {
  font-size: 12px;
  color: var(--so-text);
}

/* ---- MP Cross-Reference Card ---- */
.mp-crossref {
  border-radius: 6px;
  padding: 14px 16px;
  margin-bottom: 16px;
  display: flex;
  align-items: flex-start;
  gap: 14px;
}
.mp-crossref.exp-known {
  background: var(--so-green-bg);
  border: 2px solid var(--so-green);
}
.mp-crossref.comp-known {
  background: var(--so-yellow-bg);
  border: 2px solid #d4a017;
}
.mp-crossref-icon {
  font-size: 28px;
  flex-shrink: 0;
  line-height: 1;
}
.mp-crossref-body {
  flex: 1;
  min-width: 0;
}
.mp-crossref-body .mp-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 4px;
}
.mp-crossref-body .mp-detail {
  font-size: 12px;
  color: var(--so-text-light);
  margin-bottom: 4px;
}
.mp-crossref-body a {
  color: var(--so-link);
  text-decoration: none;
  font-size: 12px;
}
.mp-crossref-body a:hover { text-decoration: underline; }
.synth-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  margin-left: 8px;
  vertical-align: middle;
}
.synth-badge.synth { background: var(--so-green); color: #fff; }
.synth-badge.not-synth { background: #d4a017; color: #fff; }

/* ---- Related Materials ---- */
.related-materials {
  margin-top: 4px;
}
.related-materials h3 {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--so-text);
  border-bottom: 1px solid var(--so-border);
  padding-bottom: 4px;
}
.related-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 8px;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: background .1s;
}
.related-item:last-child { border-bottom: none; }
.related-item:hover { background: #f8f9f9; }
.related-item-formula {
  font-size: 13px;
  color: var(--so-link);
  font-weight: 600;
  min-width: 100px;
}
.related-item-formula:hover { color: #0a95ff; }
.related-item-gii {
  font-size: 12px;
  font-weight: 600;
  min-width: 65px;
  text-align: right;
}
.related-item-reason {
  font-size: 11px;
  color: var(--so-text-light);
  flex: 1;
}
</style>
<style id="route-style">.main-container{opacity:0}</style>
</head>
<body>

<!-- ============================================================
     HEADER
     ============================================================ -->
<header class="header">
  <nav class="header-nav">
    <a onclick="showTab('dashboard')" data-tab="dashboard">Dashboard</a>
    <a onclick="showTab('materials')" data-tab="materials">Materials</a>
    <a onclick="showTab('validators')" data-tab="validators">Validators</a>
  </nav>

  <div class="header-search">
    <input type="text" id="searchInput" placeholder="Search by formula, element, or ID..." onkeyup="handleSearch(event)">
    <svg style="position:absolute;right:8px;top:50%;transform:translateY(-50%);pointer-events:none;" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#848d95" stroke-width="2.5" stroke-linecap="round"><circle cx="10" cy="10" r="7"/><line x1="15" y1="15" x2="21" y2="21"/></svg>
  </div>

</header>

<!-- ============================================================
     MAIN CONTENT
     ============================================================ -->
<div class="main-container">
  <div class="content-area">

    <!-- ---- Dashboard tab ---- -->
    <div id="tab-dashboard" class="tab-content">
      <div class="hero-banner">
        <h2 style="color:var(--so-orange);font-weight:600;">Claude is curious about materials</h2>
        <div class="hero-sub">
          Go to <a href="/materials" style="color:var(--so-orange);text-decoration:underline;cursor:pointer;" onclick="event.preventDefault();showTab('materials')">Materials</a> and see what Claude thinks of them!
        </div>
      </div>

      <div class="opus-dashboard-widget" id="opus-dashboard"></div>

      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3>Dataset Overview</h3>
          <div id="stats-overview" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;"></div>
        </div>
        <div class="dashboard-card">
          <h3>Novelty Breakdown</h3>
          <div id="chart-novelty" style="height:220px;"></div>
        </div>
        <div class="dashboard-card">
          <h3>Bond Valence Sum (GII) Distribution</h3>
          <div id="chart-gii" style="height:220px;"></div>
        </div>
        <div class="dashboard-card">
          <h3>Pauling Rule 2 Violations</h3>
          <div id="chart-pauling" style="height:220px;"></div>
        </div>
      </div>
    </div>

    <!-- ---- Materials tab ---- -->
    <div id="tab-materials" class="tab-content hidden">
      <div id="materials-count" style="font-size:14px;color:var(--so-text-light);margin-bottom:12px;"></div>

      <div class="filters-bar">
        <span class="filter-label">Filter:</span>
        <select id="filter-class" onchange="applyFilters()">
          <option value="">All classes</option>
          <option value="pure_oxide">Pure oxide</option>
          <option value="oxyhalide">Oxyhalide</option>
          <option value="oxychalcogenide">Oxychalcogenide</option>
          <option value="oxynitride">Oxynitride</option>
          <option value="oxyhydride">Oxyhydride</option>
        </select>
        <select id="filter-novelty" onchange="applyFilters()">
          <option value="">All novelty</option>
          <option value="novel">Novel</option>
          <option value="computationally_known">Comp. known</option>
          <option value="experimentally_known">Exp. known</option>
        </select>
        <select id="filter-oxi" onchange="applyFilters()">
          <option value="">All oxi confidence</option>
          <option value="both_agree">Both agree</option>
          <option value="single_method">Single method</option>
          <option value="methods_disagree">Methods disagree</option>
          <option value="no_assignment">No assignment</option>
        </select>

        <div class="sort-tabs">
          <span class="filter-label" style="margin-right:6px;">Sort by:</span>
          <button class="active" onclick="setSort('gii-desc', this)">Worst GII</button>
          <button onclick="setSort('gii-asc', this)">Best GII</button>
          <button onclick="setSort('formula', this)">A-Z</button>
          <button onclick="setSort('checks', this)">Most checks</button>
        </div>
      </div>

      <div id="materials-list"></div>
      <div class="pagination" id="pagination"></div>
    </div>

    <!-- ---- Validators tab ---- -->
    <div id="tab-validators" class="tab-content hidden">
      <div id="validators-content"></div>
    </div>
  </div>

</div>

<script src="/data.js"></script>
<script>
/* ============================================================
   App State
   ============================================================ */
const PAGE_SIZE = 25;
let state = {
  tab: 'dashboard',
  filteredMaterials: [],
  sortKey: 'gii-desc',
  page: 0,
  expandedId: null,
  searchQuery: '',
  filters: { class: '', novelty: '', oxi: '' },
};

/* ============================================================
   Helpers
   ============================================================ */
function formatFormula(f) {
  if (!f) return '?';
  return f.replace(/(\d+)/g, '<sub>$1</sub>');
}

function scoreColor(checkName, score, status) {
  if (status !== 'completed') return 'skip';
  if (checkName === 'bond_valence_sum') {
    if (score <= 0.2) return 'good';
    if (score <= 0.6) return 'warn';
    return 'bad';
  }
  if (checkName === 'charge_neutrality') {
    if (score === 0) return 'good';
    if (Math.abs(score) <= 2) return 'warn';
    return 'bad';
  }
  if (checkName === 'pauling_rule2' || checkName === 'shannon_radii') {
    if (score === 0) return 'good';
    if (score <= 0.25) return 'warn';
    return 'bad';
  }
  if (checkName === 'space_group') {
    if (score > 0.1) return 'good';
    if (score > 0) return 'warn';
    return 'bad';
  }
  return 'skip';
}

function checkDisplayName(name) {
  const map = {
    'bond_valence_sum': 'Bond Valence Sum',
    'charge_neutrality': 'Charge Neutrality',
    'pauling_rule2': "Pauling's Rule 2",
    'shannon_radii': 'Shannon Radii',
    'space_group': 'Space Group',
    'goldschmidt': 'Goldschmidt',
  };
  return map[name] || name;
}

function scoreExplanation(checkName, score, details) {
  if (checkName === 'bond_valence_sum') {
    return `GII = ${score.toFixed(3)} v.u. (ICSD experimental baseline: ~0.2 v.u.)`;
  }
  if (checkName === 'charge_neutrality') {
    return score === 0 ? 'Perfectly charge neutral' : `Residual charge: ${score > 0 ? '+' : ''}${score}`;
  }
  if (checkName === 'pauling_rule2') {
    const pct = (score * 100).toFixed(1);
    const n = details?.n_oxygen_sites_checked || '?';
    return `${pct}% of ${n} oxygen sites violate the electrostatic valence rule`;
  }
  if (checkName === 'shannon_radii') {
    const pct = (score * 100).toFixed(1);
    const n = details?.n_bonds_checked || '?';
    return `${pct}% of ${n} bonds deviate >25% from expected Shannon radii distances`;
  }
  if (checkName === 'space_group') {
    const frac = (score * 100).toFixed(1);
    return score > 0
      ? `Space group observed in ${frac}% of experimental entries for this chemical system`
      : 'Space group not observed experimentally for this chemical system';
  }
  return `Score: ${score}`;
}

function assumptionText(checkName, details) {
  const oxi = details?.oxi_state_confidence || 'unknown';
  const method = details?.oxi_state_method || 'unknown';
  const oxiNote = `Oxi states: ${method} (confidence: ${oxi})`;

  if (checkName === 'bond_valence_sum') {
    return `BVS parameters calibrated on ICSD experimental structures applied to DFT-relaxed geometry. ${oxiNote}. GII > 0.2 is expected for DFT geometries.`;
  }
  if (checkName === 'charge_neutrality') {
    return `O is always -2. ${oxiNote}. Non-zero residuals usually reflect oxi-state assignment quality, not true charge imbalance.`;
  }
  if (checkName === 'pauling_rule2') {
    return `Electrostatic valence sum around each O site should equal 2 (+-25%). ${oxiNote}.`;
  }
  if (checkName === 'shannon_radii') {
    return `Bond lengths should match Shannon ionic radii sums +-25%. ${oxiNote}.`;
  }
  if (checkName === 'space_group') {
    return `Space groups observed in ICSD experimental entries for the same chemical system are more plausible. Novel space groups are not wrong, just unprecedented.`;
  }
  return '';
}

function segTip(checkName, score) {
  const name = checkDisplayName(checkName);
  if (checkName === 'bond_valence_sum') return `${name}: GII = ${score.toFixed(3)} v.u.`;
  if (checkName === 'charge_neutrality') return score === 0 ? `${name}: neutral` : `${name}: residual ${score > 0 ? '+' : ''}${score}`;
  if (checkName === 'pauling_rule2') return `${name}: ${(score * 100).toFixed(0)}% violation`;
  if (checkName === 'shannon_radii') return `${name}: ${(score * 100).toFixed(0)}% violation`;
  if (checkName === 'space_group') return score > 0 ? `${name}: ${(score * 100).toFixed(0)}% match` : `${name}: no experimental match`;
  return `${name}: ${score}`;
}

function getGII(mat) {
  const bvs = mat.checks?.bond_valence_sum;
  if (bvs && bvs.status === 'completed' && bvs.score != null) return bvs.score;
  return null;
}

function tagHTML(text, cls) {
  return `<span class="tag ${cls || ''}">${text}</span>`;
}

function matchTypeClass(mt) {
  if (mt === 'novel') return 'novel';
  if (mt === 'computationally_known') return 'comp-known';
  if (mt === 'experimentally_known') return 'exp-known';
  return '';
}

function matchTypeLabel(mt) {
  if (mt === 'novel') return 'Novel';
  if (mt === 'computationally_known') return 'Comp. known (MP)';
  if (mt === 'experimentally_known') return 'Exp. verified!';
  return mt;
}

/* ============================================================
   MP Cross-Reference Card
   ============================================================ */
function renderMPCrossRef(mat) {
  const matchType = mat.match_type;
  const mpId = mat.best_match_mp_id;
  const mpUrl = mpId ? `https://next-gen.materialsproject.org/materials/${mpId}` : null;

  if (matchType === 'experimentally_known') {
    return `<div class="mp-crossref exp-known">
      <div class="mp-crossref-icon" style="color:var(--so-green);font-size:22px;font-weight:700;">&#10003;</div>
      <div class="mp-crossref-body">
        <div class="mp-title">Experimentally Verified <span class="synth-badge synth">Synthesized</span></div>
        <div class="mp-detail">This structure matches a material that has been experimentally synthesized and characterized.</div>
        ${mpUrl ? `<a href="${mpUrl}" target="_blank" rel="noopener">${mpId} on Materials Project &#8594;</a>` : ''}
      </div>
    </div>`;
  }

  if (matchType === 'computationally_known') {
    return `<div class="mp-crossref comp-known">
      <div class="mp-crossref-icon" style="color:#d4a017;font-size:22px;font-weight:700;">~</div>
      <div class="mp-crossref-body">
        <div class="mp-title">Computationally Known <span class="synth-badge not-synth">Not yet synthesized</span></div>
        <div class="mp-detail">This structure matches a Materials Project entry from DFT calculations, but has not been experimentally synthesized. GNoME may have independently rediscovered this prediction.</div>
        ${mpUrl ? `<a href="${mpUrl}" target="_blank" rel="noopener">${mpId} on Materials Project &#8594;</a>` : ''}
      </div>
    </div>`;
  }

  // Novel — already shown as pill next to formula
  return '';
}

/* ============================================================
   Related Materials
   ============================================================ */
function findRelatedMaterials(mat) {
  const targetElements = new Set(mat.elements || []);
  const targetClass = mat.compound_class;
  const targetCrystal = mat.crystal_system;
  const targetGII = getGII(mat);
  const results = [];

  for (const m of DATA.materials) {
    if (m.material_id === mat.material_id) continue;
    let score = 0;
    const reasons = [];

    // Same element set (exact chemical system)
    const mElements = new Set(m.elements || []);
    if (mElements.size === targetElements.size && [...targetElements].every(e => mElements.has(e))) {
      score += 3;
      reasons.push('same elements');
    }

    // Same compound class + crystal system
    if (m.compound_class === targetClass && m.crystal_system === targetCrystal) {
      score += 2;
      reasons.push(targetClass + ' + ' + targetCrystal);
    }

    // Similar GII (within ±0.1)
    if (targetGII !== null) {
      const mGII = getGII(m);
      if (mGII !== null && Math.abs(mGII - targetGII) <= 0.1) {
        score += 1;
        reasons.push('similar GII');
      }
    }

    if (score > 0) {
      results.push({ material: m, score, reasons });
    }
  }

  results.sort((a, b) => b.score - a.score);
  return results.slice(0, 5);
}

function renderRelatedMaterials(mat) {
  const related = findRelatedMaterials(mat);
  if (!related.length) return '';

  let items = '';
  for (const r of related) {
    const gii = getGII(r.material);
    const giiStr = gii !== null ? gii.toFixed(2) : '?';
    const giiColor = gii !== null ? (gii <= 0.2 ? 'text-good' : gii <= 0.6 ? 'text-warn' : 'text-bad') : 'text-muted';
    items += `<div class="related-item" onclick="event.stopPropagation(); navigateToMaterial('${r.material.material_id}')">
      <span class="related-item-formula">${formatFormula(r.material.reduced_formula)}</span>
      <span class="tag ${matchTypeClass(r.material.match_type)}" style="font-size:10px;">${matchTypeLabel(r.material.match_type)}</span>
      <span class="related-item-gii ${giiColor}">GII ${giiStr}</span>
      <span class="related-item-reason">${r.reasons.join(' &middot; ')}</span>
    </div>`;
  }

  return `<div class="related-materials detail-section">
    <h3>Related Materials</h3>
    ${items}
  </div>`;
}

/* ============================================================
   Tab Navigation
   ============================================================ */
function showTab(tab, pushState) {
  state.tab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.getElementById('tab-' + tab).classList.remove('hidden');
  document.querySelectorAll('.header-nav a').forEach(a => {
    a.classList.toggle('active', a.dataset.tab === tab);
  });
  if (tab === 'materials') renderMaterialsList();
  if (tab === 'validators') renderValidators();
  if (pushState !== false) {
    history.pushState(null, '', tab === 'dashboard' ? '/' : '/' + tab);
  }
}

/* ============================================================
   Search
   ============================================================ */
function handleSearch(e) {
  if (e.key === 'Enter' || e.type === 'keyup') {
    state.searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
    state.page = 0;
    if (state.tab !== 'materials') showTab('materials');
    else applyFilters();
  }
}

/* ============================================================
   Filters & Sort
   ============================================================ */
function applyFilters() {
  state.filters.class = document.getElementById('filter-class').value;
  state.filters.novelty = document.getElementById('filter-novelty').value;
  state.filters.oxi = document.getElementById('filter-oxi').value;
  state.page = 0;
  renderMaterialsList();
}

function setSort(key, btn) {
  state.sortKey = key;
  document.querySelectorAll('.sort-tabs button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  state.page = 0;
  renderMaterialsList();
}

function getFilteredMaterials() {
  let mats = DATA.materials;
  const q = state.searchQuery;
  if (q) {
    mats = mats.filter(m =>
      (m.reduced_formula || '').toLowerCase().includes(q) ||
      (m.material_id || '').toLowerCase().includes(q) ||
      (m.elements || []).some(el => el.toLowerCase() === q) ||
      (m.composition || '').toLowerCase().includes(q)
    );
  }
  if (state.filters.class) mats = mats.filter(m => m.compound_class === state.filters.class);
  if (state.filters.novelty) mats = mats.filter(m => m.match_type === state.filters.novelty);
  if (state.filters.oxi) mats = mats.filter(m => m.oxi_confidence === state.filters.oxi);

  // Sort
  const s = state.sortKey;
  mats = [...mats];
  if (s === 'gii-desc') mats.sort((a, b) => (getGII(b) ?? -1) - (getGII(a) ?? -1));
  else if (s === 'gii-asc') mats.sort((a, b) => (getGII(a) ?? 999) - (getGII(b) ?? 999));
  else if (s === 'formula') mats.sort((a, b) => (a.reduced_formula || '').localeCompare(b.reduced_formula || ''));
  else if (s === 'checks') mats.sort((a, b) => (b.n_completed || 0) - (a.n_completed || 0));

  return mats;
}

/* ============================================================
   Render: Materials List
   ============================================================ */
function renderMaterialsList() {
  const mats = getFilteredMaterials();
  state.filteredMaterials = mats;
  const total = mats.length;
  const start = state.page * PAGE_SIZE;
  const page = mats.slice(start, start + PAGE_SIZE);

  const allTotal = DATA.materials.length;
  document.getElementById('materials-count').textContent =
    total === allTotal ? `Showing all ${allTotal.toLocaleString()} materials` : `Showing ${total.toLocaleString()} / ${allTotal.toLocaleString()} materials`;

  const checkOrder = ['charge_neutrality', 'shannon_radii', 'pauling_rule2', 'bond_valence_sum', 'space_group'];

  let html = '<div style="display:flex;gap:16px;padding:4px 16px;font-size:11px;color:var(--so-text-light);font-weight:600;"><div style="width:108px;text-align:center;cursor:help;" data-tip="Global Instability Index — lower is better (experimental baseline ~0.2)">GII (v.u.)</div><div></div></div>';
  for (const mat of page) {
    const isExpanded = state.expandedId === mat.material_id;
    // Confidence bar segments
    let barSegs = '';
    let nCompleted = 0;
    for (const cn of checkOrder) {
      const c = mat.checks?.[cn];
      const status = c?.status || 'skip';
      const color = c ? scoreColor(cn, c.score, status) : 'skip';
      if (status === 'completed') nCompleted++;
      const tipText = status === 'completed' ? segTip(cn, c.score) : checkDisplayName(cn) + ': skipped';
      barSegs += `<div class="seg ${color}" style="flex:1" data-tip="${tipText}"></div>`;
    }

    // Overall color
    const gii = getGII(mat);
    let overallClass = 'text-muted';
    let overallLabel = '?';
    if (gii !== null) {
      overallLabel = gii.toFixed(2);
      if (gii <= 0.2) overallClass = 'good';
      else if (gii <= 0.6) overallClass = 'warn';
      else overallClass = 'bad';
    }

    // Tags (structural properties only — match type is shown next to formula)
    let tags = '';
    tags += tagHTML(mat.compound_class || '?');
    tags += tagHTML(mat.crystal_system || '?');
    if (mat.has_mixed_valence) tags += tagHTML('mixed-valence', 'mixed-valence');
    if (mat.oxi_confidence === 'methods_disagree') tags += tagHTML('oxi-conflict', 'oxi-low');

    const matchPill = `<span class="match-pill ${matchTypeClass(mat.match_type)}">${matchTypeLabel(mat.match_type)}</span>`;

    html += `<div class="material-item-wrap">
    <div class="material-list-item ${isExpanded ? 'expanded' : ''}" onclick="toggleDetail('${mat.material_id}')">
      <div class="mat-confidence">
        <div class="confidence-score ${overallClass}">${overallLabel}</div>
        <div class="confidence-bar">${barSegs}</div>
      </div>
      <div class="mat-info">
        <div class="mat-title">${formatFormula(mat.reduced_formula)} ${matchPill}</div>
        <div class="mat-tags">${tags}</div>
        ${(() => { const qs = getOpusQuestions(mat.material_id); return qs.length ? `<div class="mat-question" ${isExpanded ? 'id="row-claude-q"' : ''}><span style="color:var(--so-orange);font-style:normal;font-weight:600;">Claude asks:</span> ${qs.sort((a,b) => (a.priority||2) - (b.priority||2))[0].question_text}</div>` : ''; })()}
      </div>
    </div>`;

    // Detail panel
    if (isExpanded) {
      html += renderDetailPanel(mat);
    }
    html += `</div>`;
  }

  document.getElementById('materials-list').innerHTML = html;
  renderPagination(total);

  // Scroll to expanded row on initial load
  if (state._scrollToExpanded) {
    state._scrollToExpanded = false;
    const expandedEl = document.querySelector('.material-list-item.expanded');
    if (expandedEl) {
      expandedEl.scrollIntoView({ block: 'start' });
      window.scrollBy(0, -60);
    }
  }

  // Watch the claude question in detail panel — restore row question when it scrolls away
  const detailQ = document.getElementById('detail-claude-q');
  const rowQ = document.getElementById('row-claude-q');
  if (detailQ && rowQ) {
    const obs = new IntersectionObserver(([entry]) => {
      rowQ.classList.toggle('restore', !entry.isIntersecting);
    }, { rootMargin: '-120px 0px 0px 0px', threshold: 0 });
    obs.observe(detailQ);
  }
}

function renderDetailPanel(mat) {
  const detail = DATA.details?.[mat.material_id];
  if (!detail) return '<div class="detail-panel open"><em>No details available</em></div>';

  const checks = detail.checks || {};
  const checkOrder = ['charge_neutrality', 'shannon_radii', 'pauling_rule2', 'bond_valence_sum', 'space_group'];

  let answersHtml = '';
  for (const cn of checkOrder) {
    const c = checks[cn];
    if (!c) continue;
    const status = c.status;
    const score = c.score;
    const det = c.details || {};
    const tier = c.tier || '?';
    const color = scoreColor(cn, score, status);
    const tierClass = tier === 1 ? 'tier1' : 'tier2';
    const tierLabel = tier === 1 ? 'DFT-independent' : 'DFT-dependent';

    let icon = '?';
    if (color === 'good') icon = '&#10003;';
    else if (color === 'warn') icon = '~';
    else if (color === 'bad') icon = '!';
    else if (color === 'skip') icon = '&#8722;';

    let bodyHtml = '';
    if (status === 'completed') {
      bodyHtml += `<div class="score-line">${scoreExplanation(cn, score, det)}</div>`;

      // Extra details
      if (cn === 'bond_valence_sum' && det.worst_sites?.length) {
        bodyHtml += '<div class="mt-8">';
        for (const ws of det.worst_sites) {
          bodyHtml += `<div class="detail-row">${ws.element} (site ${ws.site_index}): BVS = ${ws.bvs?.toFixed(2)}, expected ${ws.expected}, deviation ${(ws.relative_deviation * 100).toFixed(1)}%</div>`;
        }
        bodyHtml += '</div>';
      }
      if (cn === 'charge_neutrality' && det.element_charges) {
        const parts = Object.entries(det.element_charges).map(([el, info]) =>
          `${el}<sup>${info.oxi_state > 0 ? info.oxi_state + '+' : Math.abs(info.oxi_state) + '&minus;'}</sup> &times; ${info.count}`
        );
        bodyHtml += `<div class="detail-row mt-8">${parts.join(' + ')} = ${det.total_charge}</div>`;
      }
      if (cn === 'space_group' && det.top_experimental_space_groups?.length) {
        bodyHtml += '<div class="detail-row mt-8">Experimental space groups for this chemsys: ';
        bodyHtml += det.top_experimental_space_groups.map(sg =>
          `#${sg.space_group_number} (${(sg.fraction * 100).toFixed(0)}%)`
        ).join(', ');
        bodyHtml += '</div>';
      }

    } else {
      const reason = det?.skip_reason || c.error_message || status;
      bodyHtml = `<div class="detail-row text-muted">Skipped: ${reason}</div>`;
    }

    const assumption = assumptionText(cn, det);
    const tipHtml = assumption ? `<span class="assumption-tip">?<span class="tip-text">${assumption}</span></span>` : '';

    answersHtml += `
    <div class="check-answer">
      <div class="check-answer-header">
        <div class="check-icon ${color}">${icon}</div>
        <div class="check-name-wrap">
          <div class="check-name">${checkDisplayName(cn)}</div>
          ${tipHtml}
        </div>
        <div class="check-tier ${tierClass}">${tierLabel}</div>
      </div>
      <div class="check-answer-body">${bodyHtml}</div>
    </div>`;
  }

  // Material metadata
  const oxi = detail.oxi_states;
  let oxiHtml = '';
  if (oxi && typeof oxi === 'object') {
    oxiHtml = Object.entries(oxi).map(([el, os]) =>
      `${el}<sup>${os > 0 ? os + '+' : Math.abs(os) + '&minus;'}</sup>`
    ).join(', ');
  }

  const mvEl = detail.mixed_valence_elements;
  let mvHtml = '';
  if (mvEl && mvEl.length) {
    mvHtml = '<div class="detail-row"><strong>Mixed valence:</strong> ' +
      mvEl.map(mv => `${mv.element} (${mv.states.join('/')})`).join(', ') + '</div>';
  }

  const opusHtml = renderOpusQuestionsHTML(mat.material_id);

  return `<div class="detail-panel open">
    ${opusHtml}
    ${renderMPCrossRef(mat)}
    <div class="detail-section">
      <h3 style="display:flex;align-items:center;gap:6px;">Validation Checks <span class="assumption-tip">?<span class="tip-text">DFT-independent checks use only classical chemistry rules. DFT-dependent checks apply experimental parameters to DFT-relaxed geometry.</span></span></h3>
      ${answersHtml}
    </div>
    <div class="detail-section">
      <h3>Material Properties</h3>
      <div class="detail-row"><strong>Oxidation states:</strong> ${oxiHtml || 'Not assigned'} (${mat.oxi_confidence || '?'} confidence, ${mat.oxi_method || '?'})</div>
      ${mvHtml}
      <div class="detail-row"><strong>Space group:</strong> ${mat.space_group} (#${mat.space_group_number}) &mdash; ${mat.crystal_system}</div>
      <div class="detail-row"><strong>Formation energy:</strong> ${mat.formation_energy_per_atom?.toFixed(3) || '?'} eV/atom</div>
      <div class="detail-row"><strong>Band gap:</strong> ${mat.bandgap?.toFixed(3) || '?'} eV</div>
    </div>
    ${renderRelatedMaterials(mat)}
  </div>`;
}

function toggleDetail(materialId) {
  if (state.expandedId === materialId) {
    state.expandedId = null;
    history.pushState(null, '', '/materials');
  } else {
    state.expandedId = materialId;
    history.pushState({ material: materialId }, '', '/materials/' + materialId);
  }
  renderMaterialsList();
}

function renderPagination(total) {
  const nPages = Math.ceil(total / PAGE_SIZE);
  if (nPages <= 1) { document.getElementById('pagination').innerHTML = ''; return; }

  const current = state.page;
  const pages = new Set();

  // Always show first and last
  pages.add(0);
  pages.add(nPages - 1);

  // Show window around current
  for (let i = Math.max(0, current - 2); i <= Math.min(nPages - 1, current + 2); i++) {
    pages.add(i);
  }

  const sorted = [...pages].sort((a, b) => a - b);
  let html = '';

  if (current > 0) html += `<button onclick="goPage(${current - 1})">Prev</button>`;

  let prev = -1;
  for (const p of sorted) {
    if (prev >= 0 && p - prev > 1) html += `<span style="padding:4px 2px;color:var(--so-text-light);">&hellip;</span>`;
    html += `<button class="${p === current ? 'active' : ''}" onclick="goPage(${p})">${p + 1}</button>`;
    prev = p;
  }

  if (current < nPages - 1) html += `<button onclick="goPage(${current + 1})">Next</button>`;


  document.getElementById('pagination').innerHTML = html;
}

function goPage(p) {
  state.page = p;
  renderMaterialsList();
  window.scrollTo(0, document.body.scrollHeight);
}

/* ============================================================
   Render: Dashboard
   ============================================================ */
function renderDashboard() {
  const stats = DATA.stats;

  // Overview stats
  const pureOxides = stats.compound_classes.pure_oxide || 0;
  const overviewHtml = `
    <div class="big-stat"><div class="num">${stats.total.toLocaleString()}</div><div class="label">Materials Audited</div></div>
    <div class="big-stat"><div class="num">${stats.match_types.novel?.toLocaleString() || 0}</div><div class="label">Novel</div></div>
    <div class="big-stat"><div class="num">${stats.match_types.computationally_known?.toLocaleString() || 0}</div><div class="label">Comp. Known</div></div>
    <div class="big-stat"><div class="num">${stats.match_types.experimentally_known?.toLocaleString() || 0}</div><div class="label">Exp. Verified</div></div>
    <div class="big-stat"><div class="num">${pureOxides.toLocaleString()}</div><div class="label">Pure Oxides</div></div>
    <div class="big-stat"><div class="num">${(stats.total - pureOxides).toLocaleString()}</div><div class="label">Mixed-Anion</div></div>
  `;
  document.getElementById('stats-overview').innerHTML = overviewHtml;

  // Novelty pie chart
  const noveltyData = stats.match_types;
  Plotly.newPlot('chart-novelty', [{
    labels: Object.keys(noveltyData).map(k => matchTypeLabel(k)),
    values: Object.values(noveltyData),
    type: 'pie',
    marker: { colors: ['#48A868', '#E8A317', '#0074CC'] },
    textinfo: 'label+percent',
    textposition: 'inside',
    hole: 0.35,
  }], {
    margin: { t: 10, b: 10, l: 10, r: 10 },
    showlegend: false,
    font: { size: 11 },
  }, { responsive: true, displayModeBar: false });

  // GII histogram
  const giiStats = stats.check_stats.bond_valence_sum;
  if (giiStats) {
    const bins = giiStats.hist_bins;
    const midpoints = [];
    for (let i = 0; i < bins.length - 1; i++) midpoints.push((bins[i] + bins[i + 1]) / 2);
    Plotly.newPlot('chart-gii', [{
      x: midpoints,
      y: giiStats.hist_counts,
      type: 'bar',
      marker: { color: midpoints.map(v => v <= 0.2 ? '#48A868' : v <= 0.6 ? '#E8A317' : '#D1383D') },
    }], {
      margin: { t: 10, b: 40, l: 50, r: 10 },
      xaxis: { title: 'Global Instability Index (v.u.)', range: [0, 3] },
      yaxis: { title: 'Count' },
      font: { size: 11 },
      shapes: [{
        type: 'line', x0: 0.2, x1: 0.2, y0: 0, y1: 1, yref: 'paper',
        line: { color: '#48A868', width: 2, dash: 'dash' },
      }],
      annotations: [{
        x: 0.22, y: 0.95, yref: 'paper', text: 'ICSD baseline',
        showarrow: false, font: { size: 10, color: '#48A868' }, xanchor: 'left',
      }],
    }, { responsive: true, displayModeBar: false });
  }

  // Pauling histogram
  const paulStats = stats.check_stats.pauling_rule2;
  if (paulStats) {
    const bins = paulStats.hist_bins;
    const midpoints = [];
    for (let i = 0; i < bins.length - 1; i++) midpoints.push((bins[i] + bins[i + 1]) / 2);
    Plotly.newPlot('chart-pauling', [{
      x: midpoints,
      y: paulStats.hist_counts,
      type: 'bar',
      marker: { color: midpoints.map(v => v === 0 ? '#48A868' : v <= 0.25 ? '#E8A317' : '#D1383D') },
    }], {
      margin: { t: 10, b: 40, l: 50, r: 10 },
      xaxis: { title: 'Violation Fraction' },
      yaxis: { title: 'Count' },
      font: { size: 11 },
    }, { responsive: true, displayModeBar: false });
  }


}

function navigateToMaterial(materialId) {
  state.searchQuery = '';
  document.getElementById('searchInput').value = '';
  state.expandedId = materialId;
  const mats = getFilteredMaterials();
  const idx = mats.findIndex(m => m.material_id === materialId);
  state.page = idx >= 0 ? Math.floor(idx / PAGE_SIZE) : 0;
  showTab('materials', false);
  history.pushState({ material: materialId }, '', '/materials/' + materialId);
}

/* ============================================================
   Render: Sidebar
   ============================================================ */

/* ============================================================
   Render: Validators Tab
   ============================================================ */
function renderValidators() {
  const checkMeta = [
    {
      name: 'charge_neutrality', display: 'Charge Neutrality', tier: 1,
      rule: 'Sum of (oxidation state x count) for all elements = 0',
      metric: 'Residual total charge (0 = perfectly neutral)',
      assumption: 'All O is O\u00B2\u207B. Other oxidation states from BVAnalyzer/oxi_state_guesses consensus.',
      icon: '1',
    },
    {
      name: 'shannon_radii', display: 'Shannon Radii', tier: 1,
      rule: 'Bond lengths should match sum of Shannon ionic radii within 25%',
      metric: 'Fraction of bonds violating the tolerance',
      assumption: 'Shannon ionic radii (1976) with pymatgen fallback. CrystalNN for neighbor detection.',
      icon: '2',
    },
    {
      name: 'pauling_rule2', display: "Pauling's 2nd Rule", tier: 1,
      rule: 'Electrostatic bond strength sum around each O site should equal |valence of O| = 2',
      metric: 'Fraction of O sites with >25% deviation from expected valence sum',
      assumption: 'Only O\u00B2\u207B sites checked. Cation CN counts anion neighbors only (Pauling\'s definition).',
      icon: '3',
    },
    {
      name: 'bond_valence_sum', display: 'Bond Valence Sum (GII)', tier: 2,
      rule: 'Global Instability Index: RMS deviation of site BVS from formal valence',
      metric: 'GII in valence units (v.u.) &mdash; ICSD experimental baseline ~0.2 v.u.',
      assumption: 'BVS parameters calibrated on ICSD experimental structures, applied to DFT-relaxed P1 geometry. Elevated GII is expected for DFT structures.',
      icon: '4',
    },
    {
      name: 'space_group', display: 'Space Group Plausibility', tier: 2,
      rule: 'Check if the predicted space group has been observed experimentally for this chemical system',
      metric: 'Fraction of experimental entries with this space group',
      assumption: 'ICSD entries for the same chemical system. Novel space groups aren\'t wrong \u2014 just unprecedented.',
      icon: '5',
    },
  ];

  let html = '';
  for (const cm of checkMeta) {
    const s = DATA.stats.check_stats[cm.name] || {};
    const tierClass = cm.tier === 1 ? 'tier1' : 'tier2';
    const tierLabel = cm.tier === 1 ? 'DFT-independent' : 'DFT-dependent';
    const coverage = s.n_completed || 0;
    const coveragePct = ((coverage / DATA.stats.total) * 100).toFixed(1);

    html += `
    <div class="check-answer" style="margin-bottom:16px;">
      <div class="check-answer-header">
        <div class="check-icon" style="background:var(--so-orange);font-size:18px;">${cm.icon}</div>
        <div>
          <div class="check-name" style="font-size:16px;">${cm.display}</div>
          <div style="font-size:11px;color:var(--so-text-light);">${cm.rule}</div>
        </div>
        <div class="check-tier ${tierClass}">${tierLabel}</div>
      </div>
      <div class="check-answer-body">
        <div class="detail-row"><strong>Metric:</strong> ${cm.metric}</div>
        <div class="detail-row"><strong>Coverage:</strong> ${coverage.toLocaleString()} / ${DATA.stats.total.toLocaleString()} materials (${coveragePct}%)</div>
        ${s.mean != null ? `<div class="detail-row"><strong>Mean:</strong> ${s.mean} &nbsp; <strong>Median:</strong> ${s.median} &nbsp; <strong>P25-P75:</strong> ${s.p25} &ndash; ${s.p75}</div>` : ''}
        <div class="detail-row" style="margin-top:6px;"><strong>Assumption:</strong> ${cm.assumption}</div>
        <div id="chart-validator-${cm.name}" style="height:180px;margin-top:12px;"></div>
      </div>
    </div>`;
  }
  document.getElementById('validators-content').innerHTML = html;

  // Render mini histograms
  for (const cm of checkMeta) {
    const s = DATA.stats.check_stats[cm.name];
    if (!s?.hist_bins) continue;
    const bins = s.hist_bins;
    const midpoints = [];
    for (let i = 0; i < bins.length - 1; i++) midpoints.push(+((bins[i] + bins[i + 1]) / 2).toFixed(3));

    Plotly.newPlot(`chart-validator-${cm.name}`, [{
      x: midpoints,
      y: s.hist_counts,
      type: 'bar',
      marker: { color: midpoints.map(v => {
        const color = scoreColor(cm.name, v, 'completed');
        const map = { good: '#48A868', warn: '#E8A317', bad: '#D1383D', skip: '#BFC0C3' };
        return map[color] || '#BFC0C3';
      })},
    }], {
      margin: { t: 5, b: 30, l: 45, r: 10 },
      xaxis: { title: cm.name === 'bond_valence_sum' ? 'GII (v.u.)' : cm.name === 'charge_neutrality' ? 'Residual Charge' : 'Violation Fraction' },
      yaxis: { title: 'Count' },
      font: { size: 10 },
      bargap: 0.1,
    }, { responsive: true, displayModeBar: false });
  }
}

function getOpusQuestions(materialId) {
  return DATA.opus_questions?.[materialId] || [];
}

function renderOpusQuestionsHTML(materialId) {
  const questions = getOpusQuestions(materialId);
  if (!questions.length) return '';

  // Pick the highest-priority question
  const q = [...questions].sort((a, b) => (a.priority || 2) - (b.priority || 2))[0];

  return `<div class="claude-question" id="detail-claude-q">
    <span class="claude-question-label">Claude asks:</span> ${q.question_text}
  </div>`;
}

function renderOpusDashboardWidget() {
  const suspicious = [
    { id: 'a62d9c9007', formula: 'PaMoO4', desc: 'Chemically valid, geometrically unstable' },
    { id: '0e2d26aba9', formula: 'RbMn14O28', desc: 'Oxidation state disagreement' },
    { id: '0102fff5f0', formula: 'Pu7IO24', desc: 'Geometrically strained but chemically valid' },
  ];
  let html = `<h3>Claude Finds These Materials Suspicious</h3>`;
  for (const item of suspicious) {
    html += `<div class="opus-dashboard-item" onclick="navigateToMaterial('${item.id}')">
      <span class="opus-d-formula">${formatFormula(item.formula)}</span>
      <span class="opus-d-question">${item.desc}</span>
    </div>`;
  }
  html += `<div style="margin-top:8px;"><a href="/materials" style="color:var(--so-orange);font-size:12px;cursor:pointer;" onclick="event.preventDefault();showTab('materials')">See more&hellip;</a></div>`;
  document.getElementById('opus-dashboard').innerHTML = html;
}

/* ============================================================
   Initialize
   ============================================================ */
document.addEventListener('DOMContentLoaded', () => {
  renderDashboard();
  renderOpusDashboardWidget();

  // Shared tooltip element
  const tooltip = document.createElement('div');
  tooltip.className = 'bar-tooltip';
  document.body.appendChild(tooltip);

  document.addEventListener('mouseenter', (e) => {
    // Assumption tips
    const tip = e.target.closest('.assumption-tip');
    if (tip) {
      const text = tip.querySelector('.tip-text');
      if (!text) return;
      const rect = tip.getBoundingClientRect();
      text.style.left = (rect.right + 8) + 'px';
      text.style.top = rect.top + 'px';
      text.style.display = 'block';
      return;
    }
    // Data-tip tooltips (bar segments, scores, etc.)
    const tipped = e.target.closest('[data-tip]');
    if (tipped) {
      const rect = tipped.getBoundingClientRect();
      tooltip.textContent = tipped.dataset.tip;
      tooltip.style.display = 'block';
      tooltip.style.left = rect.left + 'px';
      tooltip.style.top = (rect.top - 30) + 'px';
    }
  }, true);
  document.addEventListener('mouseleave', (e) => {
    const tip = e.target.closest('.assumption-tip');
    if (tip) {
      const text = tip.querySelector('.tip-text');
      if (text) text.style.display = 'none';
      return;
    }
    if (e.target.closest('[data-tip]')) {
      tooltip.style.display = 'none';
    }
  }, true);

  // Routing: parse initial path, then reveal
  handleRoute();
  document.querySelector('.main-container').style.opacity = '1';
  const rs = document.getElementById('route-style');
  if (rs) rs.remove();
});

function handleRoute() {
  const path = location.pathname;
  const matMatch = path.match(/^\/materials\/(.+)$/);
  if (matMatch) {
    const id = decodeURIComponent(matMatch[1]);
    state.expandedId = id;
    state._scrollToExpanded = true;
    const mats = getFilteredMaterials();
    const idx = mats.findIndex(m => m.material_id === id);
    state.page = idx >= 0 ? Math.floor(idx / PAGE_SIZE) : 0;
    showTab('materials', false);
  } else if (path === '/materials' || path === '/materials/') {
    showTab('materials', false);
  } else if (path === '/validators' || path === '/validators/') {
    showTab('validators', false);
  } else {
    showTab('dashboard', false);
  }
}

window.addEventListener('popstate', (e) => {
  // Restore material state if available
  if (e.state?.material) {
    state.expandedId = e.state.material;
    const mats = getFilteredMaterials();
    const idx = mats.findIndex(m => m.material_id === e.state.material);
    state.page = idx >= 0 ? Math.floor(idx / PAGE_SIZE) : 0;
    showTab('materials', false);
  } else {
    state.expandedId = null;
    handleRoute();
  }
});
</script>
</body>
</html>
