<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StackOverBond</title>
<script src="https://cdn.plot.ly/plotly-2.35.0.min.js"></script>
<style>
/* ============================================================
   StackOverBond — SO-inspired theme
   ============================================================ */
:root {
  --so-orange: #F48024;
  --so-dark: #232629;
  --so-bg: #F1F2F3;
  --so-white: #ffffff;
  --so-border: #d6d9dc;
  --so-text: #3b4045;
  --so-text-light: #6a737c;
  --so-link: #0074CC;
  --so-tag-bg: #E1ECF4;
  --so-tag-text: #39739D;
  --so-green: #2F6F44;
  --so-green-bg: #d4edda;
  --so-red: #C22E32;
  --so-red-bg: #fce4e4;
  --so-gold: #F1B600;
  --so-yellow-bg: #FDF7E2;
  --tier1: #2F6F44;
  --tier2: #5B6987;
  --check-good: #48A868;
  --check-warn: #E8A317;
  --check-bad: #D1383D;
  --check-skip: #BFC0C3;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Liberation Sans", sans-serif;
  font-size: 13px;
  color: var(--so-text);
  background: var(--so-bg);
  line-height: 1.5;
}

/* ---- Header (SO top bar) ---- */
.header {
  background: var(--so-dark);
  height: 50px;
  display: flex;
  align-items: center;
  padding: 0 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 1px 2px rgba(0,0,0,.1);
}
.header-logo {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--so-white);
  font-size: 18px;
  font-weight: 400;
  text-decoration: none;
  padding: 0 8px;
  cursor: pointer;
}
.header-logo .logo-icon { font-size: 24px; }
.header-logo .logo-stack { font-weight: 300; }
.header-logo .logo-over { font-weight: 700; color: var(--so-orange); }
.header-logo .logo-bond { font-weight: 300; }

.header-nav {
  display: flex;
  gap: 4px;
  margin-left: 16px;
}
.header-nav a {
  color: #b6bdc4;
  text-decoration: none;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  cursor: pointer;
  transition: background .15s, color .15s;
}
.header-nav a:hover { background: #3b4045; color: #fff; }
.header-nav a.active { background: var(--so-orange); color: #fff; }

.header-search {
  flex: 1;
  max-width: 500px;
  margin-left: 16px;
  position: relative;
}
.header-search input {
  width: 100%;
  padding: 6px 10px 6px 32px;
  border: 1px solid #555;
  border-radius: 3px;
  background: #3b4045;
  color: #fff;
  font-size: 13px;
  outline: none;
}
.header-search input:focus { border-color: var(--so-link); background: #232629; }
.header-search input::placeholder { color: #848d95; }
.header-search .search-icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: #848d95;
  font-size: 14px;
}

.header-user {
  margin-left: auto;
  color: #b6bdc4;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.header-user .rep {
  background: var(--so-orange);
  color: #fff;
  padding: 2px 6px;
  border-radius: 3px;
  font-weight: 700;
  font-size: 11px;
}

/* ---- Main layout ---- */
.main-container {
  max-width: 1264px;
  margin: 0 auto;
  display: flex;
  gap: 24px;
  padding: 24px 16px;
}
.content-area { flex: 1; min-width: 0; }
.sidebar { width: 300px; flex-shrink: 0; }

/* ---- Tab content header ---- */
.content-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.content-header h1 {
  font-size: 27px;
  font-weight: 400;
  color: var(--so-text);
}
.content-header .subtitle {
  font-size: 13px;
  color: var(--so-text-light);
}

/* ---- Material list (SO question list) ---- */
.material-list-item {
  background: var(--so-white);
  border: 1px solid var(--so-border);
  border-bottom: none;
  padding: 12px 16px;
  display: flex;
  gap: 16px;
  align-items: flex-start;
  cursor: pointer;
  transition: background .1s;
}
.material-list-item:last-child { border-bottom: 1px solid var(--so-border); }
.material-list-item:hover { background: #f8f9f9; }
.material-list-item.expanded { background: var(--so-yellow-bg); border-left: 3px solid var(--so-orange); }

/* Vote / Confidence anatomy column */
.mat-confidence {
  width: 108px;
  flex-shrink: 0;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.confidence-bar {
  width: 100%;
  height: 8px;
  border-radius: 4px;
  display: flex;
  overflow: hidden;
  background: var(--check-skip);
}
.confidence-bar .seg {
  height: 100%;
  transition: opacity .2s;
  position: relative;
}
.confidence-bar .seg:hover { opacity: 0.8; }
.confidence-bar .seg.good { background: var(--check-good); }
.confidence-bar .seg.warn { background: var(--check-warn); }
.confidence-bar .seg.bad { background: var(--check-bad); }
.confidence-bar .seg.skip { background: var(--check-skip); }

.confidence-label {
  font-size: 11px;
  color: var(--so-text-light);
}
.confidence-score {
  font-size: 18px;
  font-weight: 600;
  color: var(--so-text);
}
.confidence-score.good { color: var(--check-good); }
.confidence-score.warn { color: var(--check-warn); }
.confidence-score.bad { color: var(--check-bad); }

/* Material info column */
.mat-info { flex: 1; min-width: 0; }
.mat-title {
  font-size: 17px;
  color: var(--so-link);
  margin-bottom: 4px;
  font-weight: 400;
}
.mat-title:hover { color: #0a95ff; }
.mat-meta {
  font-size: 12px;
  color: var(--so-text-light);
  margin-bottom: 6px;
}
.mat-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}
.tag {
  display: inline-block;
  padding: 2px 6px;
  background: var(--so-tag-bg);
  color: var(--so-tag-text);
  border-radius: 3px;
  font-size: 12px;
  white-space: nowrap;
}
.tag.novel { background: #d4edda; color: #155724; }
.tag.comp-known { background: #fff3cd; color: #856404; }
.tag.exp-known { background: #d1ecf1; color: #0c5460; }
.tag.tier1 { background: #e8f5e9; color: var(--tier1); }
.tag.tier2 { background: #e3e8ef; color: var(--tier2); }
.tag.oxi-low { background: #fce4e4; color: var(--so-red); }
.tag.mixed-valence { background: #f3e5f5; color: #7b1fa2; }

/* ---- Detail panel (expands inline) ---- */
.detail-panel {
  background: var(--so-white);
  border: 1px solid var(--so-border);
  border-top: none;
  padding: 16px 24px;
  display: none;
}
.detail-panel.open { display: block; }

.detail-section {
  margin-bottom: 20px;
}
.detail-section h3 {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--so-text);
  border-bottom: 1px solid var(--so-border);
  padding-bottom: 4px;
}

/* Check "answer" cards */
.check-answer {
  border: 1px solid var(--so-border);
  border-radius: 4px;
  margin-bottom: 12px;
  overflow: hidden;
}
.check-answer-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 14px;
  background: #f8f9f9;
  border-bottom: 1px solid var(--so-border);
}
.check-answer-header .check-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  flex-shrink: 0;
}
.check-answer-header .check-icon.good { background: var(--check-good); }
.check-answer-header .check-icon.warn { background: var(--check-warn); }
.check-answer-header .check-icon.bad { background: var(--check-bad); }
.check-answer-header .check-icon.skip { background: var(--check-skip); }

.check-answer-header .check-name {
  font-weight: 600;
  font-size: 14px;
}
.check-answer-header .check-tier {
  margin-left: auto;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
}
.check-answer-header .check-tier.tier1 {
  background: #e8f5e9;
  color: var(--tier1);
}
.check-answer-header .check-tier.tier2 {
  background: #e3e8ef;
  color: var(--tier2);
}

.check-answer-body {
  padding: 12px 14px;
}
.check-answer-body .score-line {
  font-size: 15px;
  margin-bottom: 6px;
}
.check-answer-body .assumption {
  background: var(--so-yellow-bg);
  border-left: 3px solid var(--so-gold);
  padding: 8px 12px;
  font-size: 12px;
  color: var(--so-text-light);
  margin-top: 8px;
  border-radius: 0 3px 3px 0;
}
.check-answer-body .assumption strong {
  color: var(--so-text);
}
.check-answer-body .detail-row {
  font-size: 12px;
  color: var(--so-text-light);
  margin: 2px 0;
}

/* ---- Sidebar widgets (SO-style) ---- */
.sidebar-widget {
  background: var(--so-white);
  border: 1px solid var(--so-border);
  border-radius: 4px;
  margin-bottom: 16px;
  overflow: hidden;
}
.sidebar-widget-header {
  background: #f8f9f9;
  padding: 10px 14px;
  border-bottom: 1px solid var(--so-border);
  font-weight: 600;
  font-size: 13px;
  color: var(--so-text);
}
.sidebar-widget-body {
  padding: 12px 14px;
}

/* Hot Network Questions */
.hot-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  padding: 6px 0;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  font-size: 12px;
  color: var(--so-link);
  text-decoration: none;
}
.hot-item:last-child { border-bottom: none; }
.hot-item:hover { color: #0a95ff; }
.hot-item .hot-icon {
  font-size: 14px;
  flex-shrink: 0;
  margin-top: 1px;
}
.hot-item .hot-label {
  font-size: 10px;
  color: var(--so-text-light);
  margin-top: 2px;
}

/* Stats widget */
.stat-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 12px;
}
.stat-row .stat-val {
  font-weight: 700;
}

/* ---- Filters bar ---- */
.filters-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
  align-items: center;
}
.filters-bar select {
  padding: 4px 8px;
  border: 1px solid var(--so-border);
  border-radius: 3px;
  font-size: 12px;
  background: var(--so-white);
  color: var(--so-text);
}
.filters-bar .filter-label {
  font-size: 12px;
  color: var(--so-text-light);
  font-weight: 600;
}
.sort-tabs {
  display: flex;
  gap: 0;
  margin-left: auto;
}
.sort-tabs button {
  padding: 4px 12px;
  border: 1px solid var(--so-border);
  background: var(--so-white);
  font-size: 12px;
  color: var(--so-text-light);
  cursor: pointer;
}
.sort-tabs button:first-child { border-radius: 3px 0 0 3px; }
.sort-tabs button:last-child { border-radius: 0 3px 3px 0; }
.sort-tabs button:not(:first-child) { border-left: none; }
.sort-tabs button.active { background: #e3e6e8; color: var(--so-text); }

/* ---- Dashboard ---- */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 24px;
}
.dashboard-card {
  background: var(--so-white);
  border: 1px solid var(--so-border);
  border-radius: 4px;
  padding: 16px;
}
.dashboard-card.full-width {
  grid-column: 1 / -1;
}
.dashboard-card h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--so-text);
}

.big-stat {
  text-align: center;
  padding: 12px;
}
.big-stat .num {
  font-size: 36px;
  font-weight: 700;
  color: var(--so-orange);
}
.big-stat .label {
  font-size: 13px;
  color: var(--so-text-light);
}

/* ---- Hero / Featured Failure ---- */
.hero-banner {
  background: linear-gradient(135deg, var(--so-dark) 0%, #3b4045 100%);
  border-radius: 8px;
  padding: 28px 32px;
  margin-bottom: 24px;
  color: #fff;
  position: relative;
  overflow: hidden;
}
.hero-banner::after {
  content: "";
  position: absolute;
  right: -40px;
  top: -40px;
  width: 200px;
  height: 200px;
  border-radius: 50%;
  background: rgba(244, 128, 36, 0.08);
}
.hero-banner h2 {
  font-size: 22px;
  font-weight: 400;
  margin-bottom: 4px;
}
.hero-banner h2 .accent { color: var(--so-orange); font-weight: 700; }
.hero-banner .hero-sub {
  font-size: 14px;
  color: #b6bdc4;
  margin-bottom: 16px;
}
.hero-banner .hero-tagline {
  font-size: 12px;
  color: #848d95;
  font-style: italic;
  margin-top: 12px;
}

.hero-material {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 6px;
  padding: 16px;
  display: flex;
  gap: 20px;
  cursor: pointer;
}
.hero-material:hover { background: rgba(255,255,255,0.1); }
.hero-material .hero-formula {
  font-size: 24px;
  font-weight: 300;
  color: var(--so-orange);
  min-width: 140px;
}
.hero-material .hero-checks {
  flex: 1;
}
.hero-check-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 3px 0;
  font-size: 13px;
}
.hero-check-row .dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}
.hero-check-row .dot.good { background: var(--check-good); }
.hero-check-row .dot.bad { background: var(--check-bad); }
.hero-check-row .dot.skip { background: var(--check-skip); }
.hero-check-row .check-label { color: #b6bdc4; min-width: 140px; }
.hero-check-row .check-val { color: #fff; }

/* ---- Pagination ---- */
.pagination {
  display: flex;
  justify-content: center;
  gap: 4px;
  margin-top: 16px;
}
.pagination button {
  padding: 4px 10px;
  border: 1px solid var(--so-border);
  background: var(--so-white);
  border-radius: 3px;
  font-size: 12px;
  cursor: pointer;
  color: var(--so-text);
}
.pagination button.active {
  background: var(--so-orange);
  color: #fff;
  border-color: var(--so-orange);
}
.pagination button:hover:not(.active) { background: #e3e6e8; }

/* ---- Footer ---- */
.footer {
  background: #2d2d2d;
  color: #848d95;
  padding: 24px 16px;
  text-align: center;
  font-size: 12px;
  margin-top: 48px;
}
.footer a { color: var(--so-orange); text-decoration: none; }
.footer .footer-tagline {
  font-size: 14px;
  color: #b6bdc4;
  margin-bottom: 8px;
}

/* ---- Responsive ---- */
@media (max-width: 980px) {
  .sidebar { display: none; }
  .dashboard-grid { grid-template-columns: 1fr; }
}

/* ---- Utilities ---- */
.hidden { display: none !important; }
.text-muted { color: var(--so-text-light); }
.text-good { color: var(--check-good); }
.text-warn { color: var(--check-warn); }
.text-bad { color: var(--check-bad); }
.mt-8 { margin-top: 8px; }
.mb-8 { margin-bottom: 8px; }
sub { font-size: 0.75em; }

/* ---- Opus Lens toggle ---- */
.opus-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: 16px;
  cursor: pointer;
  user-select: none;
}
.opus-toggle .toggle-label {
  color: #848d95;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
  transition: color .2s;
}
.opus-toggle.active .toggle-label {
  color: var(--so-orange);
}
.opus-toggle .toggle-track {
  width: 36px;
  height: 20px;
  border-radius: 10px;
  background: #555;
  position: relative;
  transition: background .2s;
}
.opus-toggle.active .toggle-track {
  background: var(--so-orange);
}
.opus-toggle .toggle-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #fff;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: transform .2s;
}
.opus-toggle.active .toggle-thumb {
  transform: translateX(16px);
}

/* ---- Opus question cards ---- */
.opus-questions-section {
  overflow: hidden;
  transition: max-height .35s ease, opacity .25s ease;
  max-height: 0;
  opacity: 0;
}
.opus-questions-section.visible {
  max-height: 2000px;
  opacity: 1;
}
.opus-question-card {
  background: #FFF8F0;
  border: 1px solid #f0dcc0;
  border-left: 4px solid var(--so-orange);
  border-radius: 0 4px 4px 0;
  padding: 10px 14px;
  margin-bottom: 8px;
}
.opus-question-card .opus-q-text {
  font-size: 14px;
  color: var(--so-text);
  margin-bottom: 4px;
  line-height: 1.4;
}
.opus-question-card .opus-q-evidence {
  font-size: 12px;
  color: var(--so-text-light);
  font-style: italic;
}
.opus-q-tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 10px;
  font-weight: 600;
  margin-right: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.opus-q-tag.anomaly { background: #fce4e4; color: var(--so-red); }
.opus-q-tag.cross_validator { background: #d1ecf1; color: #0c5460; }
.opus-q-tag.dataset_context { background: #d4edda; color: #155724; }
.opus-q-tag.oxi_state { background: #f3e5f5; color: #7b1fa2; }
.opus-q-tag.priority-1 { border: 1px solid currentColor; }

/* Opus dashboard widget */
.opus-dashboard-widget {
  background: #FFF8F0;
  border: 1px solid #f0dcc0;
  border-radius: 4px;
  padding: 16px;
  margin-bottom: 16px;
  overflow: hidden;
  transition: max-height .35s ease, opacity .25s ease;
  max-height: 0;
  opacity: 0;
}
.opus-dashboard-widget.visible {
  max-height: 2000px;
  opacity: 1;
}
.opus-dashboard-widget h3 {
  font-size: 14px;
  font-weight: 600;
  color: var(--so-orange);
  margin-bottom: 12px;
}
.opus-dashboard-item {
  padding: 8px 0;
  border-bottom: 1px solid #f0dcc0;
  cursor: pointer;
}
.opus-dashboard-item:last-child { border-bottom: none; }
.opus-dashboard-item:hover { background: #FFF0E0; margin: 0 -16px; padding: 8px 16px; }
.opus-dashboard-item .opus-d-formula {
  font-size: 13px;
  font-weight: 600;
  color: var(--so-link);
}
.opus-dashboard-item .opus-d-question {
  font-size: 12px;
  color: var(--so-text);
  margin-top: 2px;
}

/* Opus sidebar widget */
.opus-sidebar-stats {
  overflow: hidden;
  transition: max-height .35s ease, opacity .25s ease;
  max-height: 0;
  opacity: 0;
}
.opus-sidebar-stats.visible {
  max-height: 500px;
  opacity: 1;
}
</style>
</head>
<body>

<!-- ============================================================
     HEADER
     ============================================================ -->
<header class="header">
  <a class="header-logo" onclick="showTab('dashboard')">
    <span class="logo-icon">&#9883;</span>
    <span class="logo-stack">Stack</span><span class="logo-over">Over</span><span class="logo-bond">Bond</span>
  </a>

  <nav class="header-nav">
    <a onclick="showTab('dashboard')" data-tab="dashboard" class="active">Dashboard</a>
    <a onclick="showTab('materials')" data-tab="materials">Materials</a>
    <a onclick="showTab('validators')" data-tab="validators">Validators</a>
  </nav>

  <div class="header-search">
    <span class="search-icon">&#128269;</span>
    <input type="text" id="searchInput" placeholder="Search by formula, element, or ID..." onkeyup="handleSearch(event)">
  </div>

  <div class="opus-toggle" id="opusToggle" onclick="toggleOpus()">
    <span class="toggle-label">Opus Lens</span>
    <div class="toggle-track"><div class="toggle-thumb"></div></div>
  </div>

  <div class="header-user">
    <span>Logged in as <strong>GNoME</strong> &#129302;</span>
    <span class="rep">1 rep</span>
  </div>
</header>

<!-- ============================================================
     MAIN CONTENT
     ============================================================ -->
<div class="main-container">
  <div class="content-area">

    <!-- ---- Dashboard tab ---- -->
    <div id="tab-dashboard" class="tab-content">
      <div class="hero-banner">
        <h2>Welcome to <span class="accent">StackOverBond</span></h2>
        <div class="hero-sub">
          Auditing 3,262 GNoME crystal predictions with classical chemistry rules &mdash;
          independent of the DFT/ML training pipeline
        </div>
        <div id="hero-featured"></div>
        <div class="hero-tagline">
          "Stack Overflow took 15 years to make AI good enough to kill it. We're speedrunning." &mdash; est. 2025
        </div>
      </div>

      <div class="opus-dashboard-widget" id="opus-dashboard"></div>

      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3>Dataset Overview</h3>
          <div id="stats-overview" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"></div>
        </div>
        <div class="dashboard-card">
          <h3>Novelty Breakdown</h3>
          <div id="chart-novelty" style="height:220px;"></div>
        </div>
        <div class="dashboard-card">
          <h3>Bond Valence Sum (GII) Distribution</h3>
          <div id="chart-gii" style="height:220px;"></div>
        </div>
        <div class="dashboard-card">
          <h3>Pauling Rule 2 Violations</h3>
          <div id="chart-pauling" style="height:220px;"></div>
        </div>
        <div class="dashboard-card full-width">
          <h3>Scores by Compound Class</h3>
          <div id="chart-compound" style="height:260px;"></div>
        </div>
      </div>
    </div>

    <!-- ---- Materials tab ---- -->
    <div id="tab-materials" class="tab-content hidden">
      <div class="content-header">
        <div>
          <h1>Materials</h1>
          <div class="subtitle" id="materials-count"></div>
        </div>
      </div>

      <div class="filters-bar">
        <span class="filter-label">Filter:</span>
        <select id="filter-class" onchange="applyFilters()">
          <option value="">All classes</option>
          <option value="pure_oxide">Pure oxide</option>
          <option value="oxyhalide">Oxyhalide</option>
          <option value="oxychalcogenide">Oxychalcogenide</option>
          <option value="oxynitride">Oxynitride</option>
          <option value="oxyhydride">Oxyhydride</option>
        </select>
        <select id="filter-novelty" onchange="applyFilters()">
          <option value="">All novelty</option>
          <option value="novel">Novel</option>
          <option value="computationally_known">Comp. known</option>
          <option value="experimentally_known">Exp. known</option>
        </select>
        <select id="filter-oxi" onchange="applyFilters()">
          <option value="">All oxi confidence</option>
          <option value="both_agree">Both agree</option>
          <option value="single_method">Single method</option>
          <option value="methods_disagree">Methods disagree</option>
          <option value="no_assignment">No assignment</option>
        </select>

        <div class="sort-tabs">
          <button class="active" onclick="setSort('gii-desc', this)">Worst GII</button>
          <button onclick="setSort('gii-asc', this)">Best GII</button>
          <button onclick="setSort('formula', this)">Formula</button>
          <button onclick="setSort('checks', this)">Most checks</button>
        </div>
      </div>

      <div id="materials-list"></div>
      <div class="pagination" id="pagination"></div>
    </div>

    <!-- ---- Validators tab ---- -->
    <div id="tab-validators" class="tab-content hidden">
      <div class="content-header">
        <h1>Validators</h1>
        <div class="subtitle">The independent checks applied to every material</div>
      </div>
      <div id="validators-content"></div>
    </div>
  </div>

  <!-- ---- Sidebar ---- -->
  <aside class="sidebar">
    <div class="opus-sidebar-stats" id="opus-sidebar">
      <div class="sidebar-widget">
        <div class="sidebar-widget-header" style="background:var(--so-orange);color:#fff;">Opus Lens Stats</div>
        <div class="sidebar-widget-body" id="opus-sidebar-content"></div>
      </div>
    </div>

    <div class="sidebar-widget">
      <div class="sidebar-widget-header">&#128293; Interesting Failures</div>
      <div class="sidebar-widget-body" id="hot-questions"></div>
    </div>

    <div class="sidebar-widget">
      <div class="sidebar-widget-header">Dataset Stats</div>
      <div class="sidebar-widget-body" id="sidebar-stats"></div>
    </div>

    <div class="sidebar-widget">
      <div class="sidebar-widget-header">&#127942; Badges</div>
      <div class="sidebar-widget-body" id="badges-widget" style="font-size:12px;"></div>
    </div>
  </aside>
</div>

<!-- ============================================================
     FOOTER
     ============================================================ -->
<footer class="footer">
  <div class="footer-tagline">Building the dataset we wish AI already had&trade;</div>
  <div>
    <a href="#">StackOverBond</a> &middot;
    Auditing <strong>3,262</strong> GNoME predictions with chemistry, not hype &middot;
    Not affiliated with Stack Overflow (but spiritually indebted)
  </div>
</footer>

<script src="data.js"></script>
<script>
/* ============================================================
   App State
   ============================================================ */
const PAGE_SIZE = 25;
let state = {
  tab: 'dashboard',
  filteredMaterials: [],
  sortKey: 'gii-desc',
  page: 0,
  expandedId: null,
  searchQuery: '',
  filters: { class: '', novelty: '', oxi: '' },
  opusEnabled: false,
};

/* ============================================================
   Helpers
   ============================================================ */
function formatFormula(f) {
  if (!f) return '?';
  return f.replace(/(\d+)/g, '<sub>$1</sub>');
}

function scoreColor(checkName, score, status) {
  if (status !== 'completed') return 'skip';
  if (checkName === 'bond_valence_sum') {
    if (score <= 0.2) return 'good';
    if (score <= 0.6) return 'warn';
    return 'bad';
  }
  if (checkName === 'charge_neutrality') {
    if (score === 0) return 'good';
    if (Math.abs(score) <= 2) return 'warn';
    return 'bad';
  }
  if (checkName === 'pauling_rule2' || checkName === 'shannon_radii') {
    if (score === 0) return 'good';
    if (score <= 0.25) return 'warn';
    return 'bad';
  }
  if (checkName === 'space_group') {
    if (score > 0.1) return 'good';
    if (score > 0) return 'warn';
    return 'bad';
  }
  return 'skip';
}

function checkDisplayName(name) {
  const map = {
    'bond_valence_sum': 'Bond Valence Sum',
    'charge_neutrality': 'Charge Neutrality',
    'pauling_rule2': "Pauling's Rule 2",
    'shannon_radii': 'Shannon Radii',
    'space_group': 'Space Group',
    'goldschmidt': 'Goldschmidt',
  };
  return map[name] || name;
}

function scoreExplanation(checkName, score, details) {
  if (checkName === 'bond_valence_sum') {
    return `GII = ${score.toFixed(3)} v.u. (ICSD experimental baseline: ~0.2 v.u.)`;
  }
  if (checkName === 'charge_neutrality') {
    return score === 0 ? 'Perfectly charge neutral' : `Residual charge: ${score > 0 ? '+' : ''}${score}`;
  }
  if (checkName === 'pauling_rule2') {
    const pct = (score * 100).toFixed(1);
    const n = details?.n_oxygen_sites_checked || '?';
    return `${pct}% of ${n} oxygen sites violate the electrostatic valence rule`;
  }
  if (checkName === 'shannon_radii') {
    const pct = (score * 100).toFixed(1);
    const n = details?.n_bonds_checked || '?';
    return `${pct}% of ${n} bonds deviate >25% from expected Shannon radii distances`;
  }
  if (checkName === 'space_group') {
    const frac = (score * 100).toFixed(1);
    return score > 0
      ? `Space group observed in ${frac}% of experimental entries for this chemical system`
      : 'Space group not observed experimentally for this chemical system';
  }
  return `Score: ${score}`;
}

function assumptionText(checkName, details) {
  const oxi = details?.oxi_state_confidence || 'unknown';
  const method = details?.oxi_state_method || 'unknown';
  const oxiNote = `Oxi states: ${method} (confidence: ${oxi})`;

  if (checkName === 'bond_valence_sum') {
    return `<strong>Assumption:</strong> BVS parameters calibrated on ICSD experimental structures applied to DFT-relaxed geometry. ${oxiNote}. GII &gt; 0.2 is expected for DFT geometries — this is a calibration offset, not necessarily a failure.`;
  }
  if (checkName === 'charge_neutrality') {
    return `<strong>Assumption:</strong> O is always &minus;2. ${oxiNote}. Non-zero residuals usually reflect oxi-state assignment quality, not true charge imbalance.`;
  }
  if (checkName === 'pauling_rule2') {
    const warn = details?.compound_class_warning || '';
    return `<strong>Assumption:</strong> Electrostatic valence sum around each O site should equal 2 (&plusmn;25%). ${oxiNote}.${warn ? ' <em>' + warn + '</em>' : ''}`;
  }
  if (checkName === 'shannon_radii') {
    const warn = details?.compound_class_warning || '';
    const fb = details?.n_pymatgen_fallback;
    const fbNote = fb ? ` (${fb} bonds used pymatgen fallback radii)` : '';
    return `<strong>Assumption:</strong> Bond lengths should match Shannon ionic radii sums &plusmn;25%. ${oxiNote}.${fbNote}${warn ? ' <em>' + warn + '</em>' : ''}`;
  }
  if (checkName === 'space_group') {
    return `<strong>Assumption:</strong> Space groups observed in ICSD experimental entries for the same chemical system are more plausible. Novel space groups aren't wrong — just unprecedented.`;
  }
  return '';
}

function getGII(mat) {
  const bvs = mat.checks?.bond_valence_sum;
  if (bvs && bvs.status === 'completed' && bvs.score != null) return bvs.score;
  return null;
}

function tagHTML(text, cls) {
  return `<span class="tag ${cls || ''}">${text}</span>`;
}

function matchTypeClass(mt) {
  if (mt === 'novel') return 'novel';
  if (mt === 'computationally_known') return 'comp-known';
  if (mt === 'experimentally_known') return 'exp-known';
  return '';
}

function matchTypeLabel(mt) {
  if (mt === 'novel') return 'Novel';
  if (mt === 'computationally_known') return 'Comp. known (MP)';
  if (mt === 'experimentally_known') return 'Exp. verified!';
  return mt;
}

/* ============================================================
   Tab Navigation
   ============================================================ */
function showTab(tab) {
  state.tab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.getElementById('tab-' + tab).classList.remove('hidden');
  document.querySelectorAll('.header-nav a').forEach(a => {
    a.classList.toggle('active', a.dataset.tab === tab);
  });
  if (tab === 'materials') renderMaterialsList();
  if (tab === 'validators') renderValidators();
}

/* ============================================================
   Search
   ============================================================ */
function handleSearch(e) {
  if (e.key === 'Enter' || e.type === 'keyup') {
    state.searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
    state.page = 0;
    if (state.tab !== 'materials') showTab('materials');
    else applyFilters();
  }
}

/* ============================================================
   Filters & Sort
   ============================================================ */
function applyFilters() {
  state.filters.class = document.getElementById('filter-class').value;
  state.filters.novelty = document.getElementById('filter-novelty').value;
  state.filters.oxi = document.getElementById('filter-oxi').value;
  state.page = 0;
  renderMaterialsList();
}

function setSort(key, btn) {
  state.sortKey = key;
  document.querySelectorAll('.sort-tabs button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  state.page = 0;
  renderMaterialsList();
}

function getFilteredMaterials() {
  let mats = DATA.materials;
  const q = state.searchQuery;
  if (q) {
    mats = mats.filter(m =>
      (m.reduced_formula || '').toLowerCase().includes(q) ||
      (m.material_id || '').toLowerCase().includes(q) ||
      (m.elements || []).some(el => el.toLowerCase() === q) ||
      (m.composition || '').toLowerCase().includes(q)
    );
  }
  if (state.filters.class) mats = mats.filter(m => m.compound_class === state.filters.class);
  if (state.filters.novelty) mats = mats.filter(m => m.match_type === state.filters.novelty);
  if (state.filters.oxi) mats = mats.filter(m => m.oxi_confidence === state.filters.oxi);

  // Sort
  const s = state.sortKey;
  mats = [...mats];
  if (s === 'gii-desc') mats.sort((a, b) => (getGII(b) ?? -1) - (getGII(a) ?? -1));
  else if (s === 'gii-asc') mats.sort((a, b) => (getGII(a) ?? 999) - (getGII(b) ?? 999));
  else if (s === 'formula') mats.sort((a, b) => (a.reduced_formula || '').localeCompare(b.reduced_formula || ''));
  else if (s === 'checks') mats.sort((a, b) => (b.n_completed || 0) - (a.n_completed || 0));

  return mats;
}

/* ============================================================
   Render: Materials List
   ============================================================ */
function renderMaterialsList() {
  const mats = getFilteredMaterials();
  state.filteredMaterials = mats;
  const total = mats.length;
  const start = state.page * PAGE_SIZE;
  const page = mats.slice(start, start + PAGE_SIZE);

  document.getElementById('materials-count').textContent =
    `${total.toLocaleString()} materials` + (state.searchQuery ? ` matching "${state.searchQuery}"` : '');

  const checkOrder = ['charge_neutrality', 'shannon_radii', 'pauling_rule2', 'bond_valence_sum', 'space_group'];

  let html = '';
  for (const mat of page) {
    const isExpanded = state.expandedId === mat.material_id;
    // Confidence bar segments
    let barSegs = '';
    let nCompleted = 0;
    for (const cn of checkOrder) {
      const c = mat.checks?.[cn];
      const status = c?.status || 'skip';
      const color = c ? scoreColor(cn, c.score, status) : 'skip';
      if (status === 'completed') nCompleted++;
      barSegs += `<div class="seg ${color}" style="flex:1" title="${checkDisplayName(cn)}: ${status === 'completed' ? c.score : 'skipped'}"></div>`;
    }

    // Overall color
    const gii = getGII(mat);
    let overallClass = 'text-muted';
    let overallLabel = '?';
    if (gii !== null) {
      overallLabel = gii.toFixed(2);
      if (gii <= 0.2) overallClass = 'good';
      else if (gii <= 0.6) overallClass = 'warn';
      else overallClass = 'bad';
    }

    // Tags
    let tags = '';
    tags += tagHTML(matchTypeLabel(mat.match_type), matchTypeClass(mat.match_type));
    tags += tagHTML(mat.compound_class || '?');
    tags += tagHTML(mat.crystal_system || '?');
    if (mat.has_mixed_valence) tags += tagHTML('mixed-valence', 'mixed-valence');
    if (mat.oxi_confidence === 'methods_disagree') tags += tagHTML('oxi-conflict', 'oxi-low');

    html += `<div class="material-list-item ${isExpanded ? 'expanded' : ''}" onclick="toggleDetail('${mat.material_id}')">
      <div class="mat-confidence">
        <div class="confidence-score ${overallClass}">${overallLabel}</div>
        <div class="confidence-label">GII (v.u.)</div>
        <div class="confidence-bar">${barSegs}</div>
        <div class="confidence-label">${nCompleted}/5 checks</div>
      </div>
      <div class="mat-info">
        <div class="mat-title">${formatFormula(mat.reduced_formula)}</div>
        <div class="mat-meta">
          ${mat.space_group || '?'} &middot; ${mat.n_sites || '?'} sites &middot;
          ID: ${mat.material_id} &middot;
          <span style="font-style:italic">Predicted by GNoME, audited 0.3s ago</span>
        </div>
        <div class="mat-tags">${tags}</div>
      </div>
    </div>`;

    // Detail panel
    if (isExpanded) {
      html += renderDetailPanel(mat);
    }
  }

  document.getElementById('materials-list').innerHTML = html;
  renderPagination(total);
}

function renderDetailPanel(mat) {
  const detail = DATA.details?.[mat.material_id];
  if (!detail) return '<div class="detail-panel open"><em>No details available</em></div>';

  const checks = detail.checks || {};
  const checkOrder = ['charge_neutrality', 'shannon_radii', 'pauling_rule2', 'bond_valence_sum', 'space_group'];

  let answersHtml = '';
  for (const cn of checkOrder) {
    const c = checks[cn];
    if (!c) continue;
    const status = c.status;
    const score = c.score;
    const det = c.details || {};
    const tier = c.tier || '?';
    const color = scoreColor(cn, score, status);
    const tierClass = tier === 1 ? 'tier1' : 'tier2';
    const tierLabel = tier === 1 ? 'Tier 1 — DFT-independent' : 'Tier 2 — semi-independent';

    let icon = '?';
    if (color === 'good') icon = '&#10003;';
    else if (color === 'warn') icon = '~';
    else if (color === 'bad') icon = '!';
    else if (color === 'skip') icon = '&#8722;';

    let bodyHtml = '';
    if (status === 'completed') {
      bodyHtml += `<div class="score-line">${scoreExplanation(cn, score, det)}</div>`;

      // Extra details
      if (cn === 'bond_valence_sum' && det.worst_sites?.length) {
        bodyHtml += '<div class="mt-8">';
        for (const ws of det.worst_sites) {
          bodyHtml += `<div class="detail-row">${ws.element} (site ${ws.site_index}): BVS = ${ws.bvs?.toFixed(2)}, expected ${ws.expected}, deviation ${(ws.relative_deviation * 100).toFixed(1)}%</div>`;
        }
        bodyHtml += '</div>';
      }
      if (cn === 'charge_neutrality' && det.element_charges) {
        const parts = Object.entries(det.element_charges).map(([el, info]) =>
          `${el}<sup>${info.oxi_state > 0 ? info.oxi_state + '+' : Math.abs(info.oxi_state) + '&minus;'}</sup> &times; ${info.count}`
        );
        bodyHtml += `<div class="detail-row mt-8">${parts.join(' + ')} = ${det.total_charge}</div>`;
      }
      if (cn === 'space_group' && det.top_experimental_space_groups?.length) {
        bodyHtml += '<div class="detail-row mt-8">Experimental space groups for this chemsys: ';
        bodyHtml += det.top_experimental_space_groups.map(sg =>
          `#${sg.space_group_number} (${(sg.fraction * 100).toFixed(0)}%)`
        ).join(', ');
        bodyHtml += '</div>';
      }

      const assumption = assumptionText(cn, det);
      if (assumption) {
        bodyHtml += `<div class="assumption">${assumption}</div>`;
      }
    } else {
      const reason = det?.skip_reason || c.error_message || status;
      bodyHtml = `<div class="detail-row text-muted">Skipped: ${reason}</div>`;
    }

    answersHtml += `
    <div class="check-answer">
      <div class="check-answer-header">
        <div class="check-icon ${color}">${icon}</div>
        <div class="check-name">${checkDisplayName(cn)}</div>
        <div class="check-tier ${tierClass}">${tierLabel}</div>
      </div>
      <div class="check-answer-body">${bodyHtml}</div>
    </div>`;
  }

  // Material metadata
  const oxi = detail.oxi_states;
  let oxiHtml = '';
  if (oxi && typeof oxi === 'object') {
    oxiHtml = Object.entries(oxi).map(([el, os]) =>
      `${el}<sup>${os > 0 ? os + '+' : Math.abs(os) + '&minus;'}</sup>`
    ).join(', ');
  }

  const mvEl = detail.mixed_valence_elements;
  let mvHtml = '';
  if (mvEl && mvEl.length) {
    mvHtml = '<div class="detail-row"><strong>Mixed valence:</strong> ' +
      mvEl.map(mv => `${mv.element} (${mv.states.join('/')})`).join(', ') + '</div>';
  }

  const opusHtml = renderOpusQuestionsHTML(mat.material_id);

  return `<div class="detail-panel open">
    ${opusHtml}
    <div class="detail-section">
      <h3>5 Answers &mdash; sorted by epistemic independence</h3>
      <div style="font-size:12px;color:var(--so-text-light);margin-bottom:12px;">
        Each answer is an independent validation check. Tier 1 checks use pre-DFT chemistry knowledge.
        Tier 2 checks apply experimental parameters to DFT geometry.
        <strong>Traceable assumptions, not just answers.</strong>
      </div>
      ${answersHtml}
    </div>
    <div class="detail-section">
      <h3>Material Properties</h3>
      <div class="detail-row"><strong>Oxidation states:</strong> ${oxiHtml || 'Not assigned'} (${mat.oxi_confidence || '?'} confidence, ${mat.oxi_method || '?'})</div>
      ${mvHtml}
      <div class="detail-row"><strong>Space group:</strong> ${mat.space_group} (#${mat.space_group_number}) &mdash; ${mat.crystal_system}</div>
      <div class="detail-row"><strong>Formation energy:</strong> ${mat.formation_energy_per_atom?.toFixed(3) || '?'} eV/atom</div>
      <div class="detail-row"><strong>Band gap:</strong> ${mat.bandgap?.toFixed(3) || '?'} eV</div>
      <div class="detail-row"><strong>MP status:</strong> ${matchTypeLabel(mat.match_type)}${mat.best_match_mp_id ? ' (' + mat.best_match_mp_id + ')' : ''}</div>
    </div>
  </div>`;
}

function toggleDetail(materialId) {
  if (state.expandedId === materialId) {
    state.expandedId = null;
  } else {
    state.expandedId = materialId;
  }
  renderMaterialsList();
}

function renderPagination(total) {
  const nPages = Math.ceil(total / PAGE_SIZE);
  if (nPages <= 1) { document.getElementById('pagination').innerHTML = ''; return; }

  let html = '';
  const current = state.page;
  const maxShow = 7;
  let startP = Math.max(0, current - 3);
  let endP = Math.min(nPages, startP + maxShow);
  if (endP - startP < maxShow) startP = Math.max(0, endP - maxShow);

  if (current > 0) html += `<button onclick="goPage(${current - 1})">Prev</button>`;
  for (let i = startP; i < endP; i++) {
    html += `<button class="${i === current ? 'active' : ''}" onclick="goPage(${i})">${i + 1}</button>`;
  }
  if (current < nPages - 1) html += `<button onclick="goPage(${current + 1})">Next</button>`;

  document.getElementById('pagination').innerHTML = html;
}

function goPage(p) {
  state.page = p;
  state.expandedId = null;
  renderMaterialsList();
  window.scrollTo(0, 200);
}

/* ============================================================
   Render: Dashboard
   ============================================================ */
function renderDashboard() {
  const stats = DATA.stats;

  // Overview stats
  const overviewHtml = `
    <div class="big-stat"><div class="num">${stats.total.toLocaleString()}</div><div class="label">Materials Audited</div></div>
    <div class="big-stat"><div class="num">${stats.match_types.novel?.toLocaleString() || 0}</div><div class="label">Truly Novel</div></div>
    <div class="big-stat"><div class="num">5</div><div class="label">Independent Checks</div></div>
    <div class="big-stat"><div class="num">${Object.keys(stats.compound_classes).length}</div><div class="label">Compound Classes</div></div>
  `;
  document.getElementById('stats-overview').innerHTML = overviewHtml;

  // Novelty pie chart
  const noveltyData = stats.match_types;
  Plotly.newPlot('chart-novelty', [{
    labels: Object.keys(noveltyData).map(k => matchTypeLabel(k)),
    values: Object.values(noveltyData),
    type: 'pie',
    marker: { colors: ['#48A868', '#E8A317', '#0074CC'] },
    textinfo: 'label+percent',
    textposition: 'inside',
    hole: 0.35,
  }], {
    margin: { t: 10, b: 10, l: 10, r: 10 },
    showlegend: false,
    font: { size: 11 },
  }, { responsive: true, displayModeBar: false });

  // GII histogram
  const giiStats = stats.check_stats.bond_valence_sum;
  if (giiStats) {
    const bins = giiStats.hist_bins;
    const midpoints = [];
    for (let i = 0; i < bins.length - 1; i++) midpoints.push((bins[i] + bins[i + 1]) / 2);
    Plotly.newPlot('chart-gii', [{
      x: midpoints,
      y: giiStats.hist_counts,
      type: 'bar',
      marker: { color: midpoints.map(v => v <= 0.2 ? '#48A868' : v <= 0.6 ? '#E8A317' : '#D1383D') },
    }], {
      margin: { t: 10, b: 40, l: 50, r: 10 },
      xaxis: { title: 'Global Instability Index (v.u.)', range: [0, 3] },
      yaxis: { title: 'Count' },
      font: { size: 11 },
      shapes: [{
        type: 'line', x0: 0.2, x1: 0.2, y0: 0, y1: 1, yref: 'paper',
        line: { color: '#48A868', width: 2, dash: 'dash' },
      }],
      annotations: [{
        x: 0.22, y: 0.95, yref: 'paper', text: 'ICSD baseline',
        showarrow: false, font: { size: 10, color: '#48A868' }, xanchor: 'left',
      }],
    }, { responsive: true, displayModeBar: false });
  }

  // Pauling histogram
  const paulStats = stats.check_stats.pauling_rule2;
  if (paulStats) {
    const bins = paulStats.hist_bins;
    const midpoints = [];
    for (let i = 0; i < bins.length - 1; i++) midpoints.push((bins[i] + bins[i + 1]) / 2);
    Plotly.newPlot('chart-pauling', [{
      x: midpoints,
      y: paulStats.hist_counts,
      type: 'bar',
      marker: { color: midpoints.map(v => v === 0 ? '#48A868' : v <= 0.25 ? '#E8A317' : '#D1383D') },
    }], {
      margin: { t: 10, b: 40, l: 50, r: 10 },
      xaxis: { title: 'Violation Fraction' },
      yaxis: { title: 'Count' },
      font: { size: 11 },
    }, { responsive: true, displayModeBar: false });
  }

  // Compound class boxplot
  const classes = Object.keys(stats.compound_classes);
  const classTraces = [];
  for (const cn of ['bond_valence_sum', 'pauling_rule2']) {
    const vals = {};
    for (const cls of classes) vals[cls] = [];
    for (const mat of DATA.materials) {
      const c = mat.checks?.[cn];
      if (c?.status === 'completed' && c.score != null) {
        vals[mat.compound_class]?.push(c.score);
      }
    }
    for (const cls of classes) {
      if (vals[cls].length > 0) {
        classTraces.push({
          y: vals[cls],
          name: `${cls} (${checkDisplayName(cn)})`,
          x: vals[cls].map(() => `${cls}<br>${checkDisplayName(cn)}`),
          type: 'box',
          boxpoints: false,
          marker: { color: cn === 'bond_valence_sum' ? '#E8A317' : '#0074CC' },
        });
      }
    }
  }
  Plotly.newPlot('chart-compound', classTraces, {
    margin: { t: 10, b: 80, l: 50, r: 10 },
    yaxis: { title: 'Score' },
    showlegend: false,
    font: { size: 10 },
    boxmode: 'group',
  }, { responsive: true, displayModeBar: false });

  // Hero featured failure
  renderHeroFailure();
}

function renderHeroFailure() {
  const tierConflict = DATA.interesting_failures?.tier_conflict;
  if (!tierConflict?.items?.length) return;

  const mat = tierConflict.items[0];
  const full = DATA.materials.find(m => m.material_id === mat.material_id);
  if (!full) return;

  const checks = [
    { name: 'Charge Neutrality', val: `Residual: ${mat.charge}`, color: mat.charge === 0 ? 'good' : 'bad' },
    { name: 'Shannon Radii', val: `Violations: ${(mat.shannon * 100).toFixed(0)}%`, color: mat.shannon === 0 ? 'good' : 'bad' },
    { name: "Pauling's Rule 2", val: `Violations: ${(mat.pauling * 100).toFixed(0)}%`, color: mat.pauling === 0 ? 'good' : 'bad' },
    { name: 'Bond Valence Sum', val: `GII: ${mat.gii?.toFixed(2)} v.u.`, color: mat.gii <= 0.2 ? 'good' : 'bad' },
  ];

  const checksHtml = checks.map(c =>
    `<div class="hero-check-row">
      <div class="dot ${c.color}"></div>
      <span class="check-label">${c.name}</span>
      <span class="check-val">${c.val}</span>
    </div>`
  ).join('');

  document.getElementById('hero-featured').innerHTML = `
    <div style="font-size:12px;color:var(--so-orange);margin-bottom:6px;font-weight:600;">
      &#128308; Featured Failure &mdash; "${tierConflict.label}"
    </div>
    <div class="hero-material" onclick="navigateToMaterial('${mat.material_id}')">
      <div class="hero-formula">${formatFormula(mat.reduced_formula)}</div>
      <div class="hero-checks">
        ${checksHtml}
        <div style="font-size:11px;color:#848d95;margin-top:6px;">
          All Tier 1 (DFT-independent) checks pass perfectly. But Tier 2 says the geometry is wildly off.
          <strong>Click to see the full breakdown &rarr;</strong>
        </div>
      </div>
    </div>
  `;
}

function navigateToMaterial(materialId) {
  // Reset filters, find material, show it
  state.searchQuery = materialId;
  document.getElementById('searchInput').value = materialId;
  state.expandedId = materialId;
  state.page = 0;
  showTab('materials');
}

/* ============================================================
   Render: Sidebar
   ============================================================ */
function renderSidebar() {
  // Interesting failures
  let hotHtml = '';
  const categories = DATA.interesting_failures || {};
  for (const [catKey, cat] of Object.entries(categories)) {
    if (!cat.items?.length) continue;
    hotHtml += `<div style="font-size:11px;font-weight:600;color:var(--so-text);margin:8px 0 4px;">${cat.label}</div>`;
    for (const item of cat.items.slice(0, 3)) {
      const giiStr = item.gii != null ? `GII: ${item.gii.toFixed(1)}` : '';
      hotHtml += `<div class="hot-item" onclick="navigateToMaterial('${item.material_id}')">
        <span class="hot-icon">&#9883;</span>
        <div>
          <div>${formatFormula(item.reduced_formula)}</div>
          <div class="hot-label">${giiStr} ${item.match_type === 'novel' ? '&middot; Novel' : ''}</div>
        </div>
      </div>`;
    }
  }
  document.getElementById('hot-questions').innerHTML = hotHtml;

  // Stats
  const stats = DATA.stats;
  let statsHtml = '';
  const statItems = [
    ['Total materials', stats.total],
    ['Novel (no MP match)', stats.match_types.novel || 0],
    ['Comp. known', stats.match_types.computationally_known || 0],
    ['Exp. verified', stats.match_types.experimentally_known || 0],
    ['Pure oxides', stats.compound_classes.pure_oxide || 0],
    ['Mixed-anion', stats.total - (stats.compound_classes.pure_oxide || 0)],
  ];
  for (const [label, val] of statItems) {
    statsHtml += `<div class="stat-row"><span>${label}</span><span class="stat-val">${val.toLocaleString()}</span></div>`;
  }
  document.getElementById('sidebar-stats').innerHTML = statsHtml;

  // Badges (trolling)
  document.getElementById('badges-widget').innerHTML = `
    <div style="margin-bottom:6px;">
      <span class="tag tier1">&#127942; Trusted Validator</span>
      <span style="color:var(--so-text-light);">Tier 1 checks &mdash; fully independent of DFT</span>
    </div>
    <div style="margin-bottom:6px;">
      <span class="tag tier2">&#129504; Peer Review</span>
      <span style="color:var(--so-text-light);">Tier 2 checks &mdash; uses experimental params on DFT geometry</span>
    </div>
    <div style="margin-bottom:6px;">
      <span class="tag novel">&#127793; Pioneer</span>
      <span style="color:var(--so-text-light);">Material not found in Materials Project</span>
    </div>
    <div>
      <span class="tag mixed-valence">&#9889; Shapeshifter</span>
      <span style="color:var(--so-text-light);">Contains elements with multiple oxidation states</span>
    </div>
  `;
}

/* ============================================================
   Render: Validators Tab
   ============================================================ */
function renderValidators() {
  const checkMeta = [
    {
      name: 'charge_neutrality', display: 'Charge Neutrality', tier: 1,
      rule: 'Sum of (oxidation state x count) for all elements = 0',
      metric: 'Residual total charge (0 = perfectly neutral)',
      assumption: 'All O is O\u00B2\u207B. Other oxidation states from BVAnalyzer/oxi_state_guesses consensus.',
      icon: '&#9889;',
    },
    {
      name: 'shannon_radii', display: 'Shannon Radii', tier: 1,
      rule: 'Bond lengths should match sum of Shannon ionic radii within 25%',
      metric: 'Fraction of bonds violating the tolerance',
      assumption: 'Shannon ionic radii (1976) with pymatgen fallback. CrystalNN for neighbor detection.',
      icon: '&#128207;',
    },
    {
      name: 'pauling_rule2', display: "Pauling's 2nd Rule", tier: 1,
      rule: 'Electrostatic bond strength sum around each O site should equal |valence of O| = 2',
      metric: 'Fraction of O sites with >25% deviation from expected valence sum',
      assumption: 'Only O\u00B2\u207B sites checked. Cation CN counts anion neighbors only (Pauling\'s definition).',
      icon: '&#9878;',
    },
    {
      name: 'bond_valence_sum', display: 'Bond Valence Sum (GII)', tier: 2,
      rule: 'Global Instability Index: RMS deviation of site BVS from formal valence',
      metric: 'GII in valence units (v.u.) &mdash; ICSD experimental baseline ~0.2 v.u.',
      assumption: 'BVS parameters calibrated on ICSD experimental structures, applied to DFT-relaxed P1 geometry. Elevated GII is expected for DFT structures.',
      icon: '&#9874;',
    },
    {
      name: 'space_group', display: 'Space Group Plausibility', tier: 2,
      rule: 'Check if the predicted space group has been observed experimentally for this chemical system',
      metric: 'Fraction of experimental entries with this space group',
      assumption: 'ICSD entries for the same chemical system. Novel space groups aren\'t wrong \u2014 just unprecedented.',
      icon: '&#128300;',
    },
  ];

  let html = '';
  for (const cm of checkMeta) {
    const s = DATA.stats.check_stats[cm.name] || {};
    const tierClass = cm.tier === 1 ? 'tier1' : 'tier2';
    const tierLabel = cm.tier === 1 ? 'Tier 1 \u2014 Fully DFT-independent' : 'Tier 2 \u2014 Semi-independent';
    const coverage = s.n_completed || 0;
    const coveragePct = ((coverage / DATA.stats.total) * 100).toFixed(1);

    html += `
    <div class="check-answer" style="margin-bottom:16px;">
      <div class="check-answer-header">
        <div class="check-icon" style="background:var(--so-orange);font-size:18px;">${cm.icon}</div>
        <div>
          <div class="check-name" style="font-size:16px;">${cm.display}</div>
          <div style="font-size:11px;color:var(--so-text-light);">${cm.rule}</div>
        </div>
        <div class="check-tier ${tierClass}">${tierLabel}</div>
      </div>
      <div class="check-answer-body">
        <div class="detail-row"><strong>Metric:</strong> ${cm.metric}</div>
        <div class="detail-row"><strong>Coverage:</strong> ${coverage.toLocaleString()} / ${DATA.stats.total.toLocaleString()} materials (${coveragePct}%)</div>
        ${s.mean != null ? `<div class="detail-row"><strong>Mean:</strong> ${s.mean} &nbsp; <strong>Median:</strong> ${s.median} &nbsp; <strong>P25-P75:</strong> ${s.p25} &ndash; ${s.p75}</div>` : ''}
        <div class="assumption"><strong>Assumption:</strong> ${cm.assumption}</div>
        <div id="chart-validator-${cm.name}" style="height:180px;margin-top:12px;"></div>
      </div>
    </div>`;
  }
  document.getElementById('validators-content').innerHTML = html;

  // Render mini histograms
  for (const cm of checkMeta) {
    const s = DATA.stats.check_stats[cm.name];
    if (!s?.hist_bins) continue;
    const bins = s.hist_bins;
    const midpoints = [];
    for (let i = 0; i < bins.length - 1; i++) midpoints.push(+((bins[i] + bins[i + 1]) / 2).toFixed(3));

    Plotly.newPlot(`chart-validator-${cm.name}`, [{
      x: midpoints,
      y: s.hist_counts,
      type: 'bar',
      marker: { color: midpoints.map(v => {
        const color = scoreColor(cm.name, v, 'completed');
        const map = { good: '#48A868', warn: '#E8A317', bad: '#D1383D', skip: '#BFC0C3' };
        return map[color] || '#BFC0C3';
      })},
    }], {
      margin: { t: 5, b: 30, l: 45, r: 10 },
      xaxis: { title: cm.name === 'bond_valence_sum' ? 'GII (v.u.)' : cm.name === 'charge_neutrality' ? 'Residual Charge' : 'Violation Fraction' },
      yaxis: { title: 'Count' },
      font: { size: 10 },
      bargap: 0.1,
    }, { responsive: true, displayModeBar: false });
  }
}

/* ============================================================
   Opus Lens
   ============================================================ */
function toggleOpus() {
  state.opusEnabled = !state.opusEnabled;
  document.getElementById('opusToggle').classList.toggle('active', state.opusEnabled);

  // Toggle question sections in currently rendered detail panels
  document.querySelectorAll('.opus-questions-section').forEach(el => {
    el.classList.toggle('visible', state.opusEnabled);
  });

  // Toggle dashboard widget
  const dashWidget = document.getElementById('opus-dashboard');
  if (state.opusEnabled) {
    renderOpusDashboardWidget();
    dashWidget.classList.add('visible');
  } else {
    dashWidget.classList.remove('visible');
  }

  // Toggle sidebar widget
  const sidebarWidget = document.getElementById('opus-sidebar');
  if (state.opusEnabled) {
    renderOpusSidebarWidget();
    sidebarWidget.classList.add('visible');
  } else {
    sidebarWidget.classList.remove('visible');
  }
}

function getOpusQuestions(materialId) {
  return DATA.opus_questions?.[materialId] || [];
}

function renderOpusQuestionsHTML(materialId) {
  const questions = getOpusQuestions(materialId);
  if (!questions.length) return '';

  const sorted = [...questions].sort((a, b) => (a.priority || 2) - (b.priority || 2));
  let html = `<div class="opus-questions-section ${state.opusEnabled ? 'visible' : ''}">
    <div class="detail-section">
      <h3 style="color:var(--so-orange);">Questions This Data Is Asking</h3>
      <div style="font-size:12px;color:var(--so-text-light);margin-bottom:12px;">
        Generated by Claude Opus 4.6 from the validation profile. Not claims &mdash; research directions.
      </div>`;

  for (const q of sorted) {
    const priorityTag = q.priority === 1 ? ' priority-1' : '';
    html += `<div class="opus-question-card">
      <div style="margin-bottom:4px;">
        <span class="opus-q-tag ${q.category}${priorityTag}">${q.category.replace('_', ' ')}</span>
        ${q.priority === 1 ? '<span class="opus-q-tag anomaly priority-1">high priority</span>' : ''}
      </div>
      <div class="opus-q-text">${q.question_text}</div>
      ${q.evidence ? `<div class="opus-q-evidence">${q.evidence}</div>` : ''}
    </div>`;
  }

  html += '</div></div>';
  return html;
}

function renderOpusDashboardWidget() {
  const questions = DATA.opus_questions || {};
  const allQs = [];
  for (const [matId, qs] of Object.entries(questions)) {
    const mat = DATA.materials.find(m => m.material_id === matId);
    for (const q of qs) {
      allQs.push({ ...q, material_id: matId, formula: mat?.reduced_formula || matId });
    }
  }

  // Sort by priority, take top 5
  allQs.sort((a, b) => (a.priority || 2) - (b.priority || 2));
  const top = allQs.slice(0, 5);

  if (!top.length) {
    document.getElementById('opus-dashboard').innerHTML =
      '<h3>Opus Lens</h3><div style="font-size:12px;color:var(--so-text-light);">No questions generated yet. Run: <code>python -m gnome_auditor.opus_questions</code></div>';
    return;
  }

  let html = `<h3>Top Opus Questions</h3>`;
  for (const q of top) {
    html += `<div class="opus-dashboard-item" onclick="navigateToMaterial('${q.material_id}')">
      <div>
        <span class="opus-q-tag ${q.category}">${q.category.replace('_', ' ')}</span>
        <span class="opus-d-formula">${formatFormula(q.formula)}</span>
      </div>
      <div class="opus-d-question">${q.question_text}</div>
    </div>`;
  }
  document.getElementById('opus-dashboard').innerHTML = html;
}

function renderOpusSidebarWidget() {
  const questions = DATA.opus_questions || {};
  const matCount = Object.keys(questions).length;
  const totalQs = Object.values(questions).reduce((s, qs) => s + qs.length, 0);

  // Category breakdown
  const cats = {};
  for (const qs of Object.values(questions)) {
    for (const q of qs) {
      cats[q.category] = (cats[q.category] || 0) + 1;
    }
  }

  let html = '';
  html += `<div class="stat-row"><span>Materials with questions</span><span class="stat-val">${matCount}</span></div>`;
  html += `<div class="stat-row"><span>Total questions</span><span class="stat-val">${totalQs}</span></div>`;
  for (const [cat, count] of Object.entries(cats).sort((a, b) => b[1] - a[1])) {
    html += `<div class="stat-row"><span><span class="opus-q-tag ${cat}">${cat.replace('_', ' ')}</span></span><span class="stat-val">${count}</span></div>`;
  }
  html += `<div style="font-size:10px;color:var(--so-text-light);margin-top:8px;">Model: Claude Opus 4.6</div>`;
  document.getElementById('opus-sidebar-content').innerHTML = html;
}

/* ============================================================
   Initialize
   ============================================================ */
document.addEventListener('DOMContentLoaded', () => {
  renderDashboard();
  renderSidebar();
});
</script>
</body>
</html>
